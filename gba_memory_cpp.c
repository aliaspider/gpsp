#include "common.h"

static u32 gbc_sound_wave_volume[4] = { 0, 16384, 8192, 4096 };

static void gbc_trigger_sound(u32 value)
{
   u32 channel;


   for (channel = 0; channel < 4; channel++)
   {
      gbc_sound_master_volume_right = value & 0x07;
      gbc_sound_master_volume_left = (value >> 4) & 0x07;
      gbc_sound_channel[channel].status =
         ((value >> (channel + 8)) & 0x01) | ((value >> (channel + 11)) & 0x03);
   }
   address16(io_registers, 0x80) = value;
}

static void sound_control_x(u32 value)
{
   if (value & 0x80)
   {
      if (sound_on != 1)
         sound_on = 1;
   }
   else
   {
      u32 i;
      for (i = 0; i < 4; i++)
         gbc_sound_channel[i].active_flag = 0;
      sound_on = 0;
   }

   address16(io_registers, 0x84) =
      (address16(io_registers, 0x84) & 0x000F) | (value & 0xFFF0);
}






extern timer_type timer[4];
static u32 prescale_table[] = { 0, 6, 8, 10 };

static void trigger_timer(u32 timer_number, u32 value)
{
   if (value & 0x80)
   {
      if(timer[timer_number].status == TIMER_INACTIVE)
      {
         u32 prescale = prescale_table[value & 0x03];
         u32 timer_reload = timer[timer_number].reload;

         if((value >> 2) & 0x01)
            timer[timer_number].status = TIMER_CASCADE;
         else
            timer[timer_number].status = TIMER_PRESCALE;

         timer[timer_number].prescale = prescale;
         timer[timer_number].irq = (value >> 6) & 0x01;

         address16(io_registers, 0x100 + (timer_number * 4)) = -timer_reload;

         timer_reload <<= prescale;
         timer[timer_number].count = timer_reload;

         if(timer_reload < execute_cycles)
            execute_cycles = timer_reload;

         if(timer_number < 2)
         {
            u32 buffer_adjust =
               (u32)(((float)(cpu_ticks - gbc_sound_last_cpu_ticks) *
                        sound_frequency) / GBC_BASE_RATE) * 2;

            timer[timer_number].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency));
            if(timer[timer_number].direct_sound_channels & (0x01 << 0)) { direct_sound_channel[0].buffer_index = (gbc_sound_buffer_index + buffer_adjust) % BUFFER_SIZE; };
            if(timer[timer_number].direct_sound_channels & (0x01 << 1)) { direct_sound_channel[1].buffer_index = (gbc_sound_buffer_index + buffer_adjust) % BUFFER_SIZE; };
         }
      }
   }
   else
   {
      if(timer[timer_number].status != TIMER_INACTIVE)
      {
         timer[timer_number].status = TIMER_INACTIVE;
         timer[timer_number].stop_cpu_ticks = cpu_ticks;
      }
   }
   address16(io_registers, 0x102 + (timer_number * 4)) = value;
}



u32 waitstate_cycles_sequential[16][3] =
{
  { 1, 1, 1 },
  { 1, 1, 1 },
  { 3, 3, 6 },
  { 1, 1, 1 },
  { 1, 1, 1 },
  { 1, 1, 2 },
  { 1, 1, 2 },
  { 1, 1, 2 },
  { 3, 3, 6 },
  { 3, 3, 6 },
  { 5, 5, 9 },
  { 5, 5, 9 },
  { 9, 9, 17 },
  { 9, 9, 17 },
};



u32 gamepak_waitstate_sequential[2][3][3] =
{
  {
    { 3, 3, 6 },
    { 5, 5, 9 },
    { 9, 9, 17 }
  },
  {
    { 2, 2, 3 },
    { 2, 2, 3 },
    { 2, 2, 3 }
  }
};

u16 palette_ram[512];
u16 oam_ram[512];
u16 palette_ram_converted[512];
u16 io_registers[1024 * 16];
u8 ewram[1024 * 256 * 2];
u8 iwram[1024 * 32 * 2];
u8 vram[1024 * 96 * 2];

u8 bios_rom[1024 * 32];
u32 bios_read_protect;


u8 gamepak_backup[1024 * 128];


u8 *gamepak_rom;
u32 gamepak_size;

dma_transfer_type dma[4];

u8 *memory_regions[16];
u32 memory_limits[16];

typedef struct
{
  u32 page_timestamp;
  u32 physical_index;
} gamepak_swap_entry_type;

u32 gamepak_ram_buffer_size;
u32 gamepak_ram_pages;


gamepak_swap_entry_type *gamepak_memory_map;

file_tag_type gamepak_file_large = NULL;



u32 direct_map_vram = 0;





u32 oam_update = 1;


u32 gbc_sound_update = 0;


u32 gbc_sound_wave_update = 0;

typedef enum
{
  BACKUP_SRAM,
  BACKUP_FLASH,
  BACKUP_EEPROM,
  BACKUP_NONE
} backup_type_type;

typedef enum
{
  SRAM_SIZE_32KB,
  SRAM_SIZE_64KB
} sram_size_type;



backup_type_type backup_type = BACKUP_NONE;
sram_size_type sram_size = SRAM_SIZE_32KB;

typedef enum
{
  FLASH_BASE_MODE,
  FLASH_ERASE_MODE,
  FLASH_ID_MODE,
  FLASH_WRITE_MODE,
  FLASH_BANKSWITCH_MODE
} flash_mode_type;

typedef enum
{
  FLASH_SIZE_64KB,
  FLASH_SIZE_128KB
} flash_size_type;

flash_mode_type flash_mode = FLASH_BASE_MODE;
u32 flash_command_position = 0;
u8 *flash_bank_ptr = gamepak_backup;

flash_device_id_type flash_device_id = FLASH_DEVICE_MACRONIX_64KB;
flash_manufacturer_id_type flash_manufacturer_id =
 FLASH_MANUFACTURER_MACRONIX;
flash_size_type flash_size = FLASH_SIZE_64KB;

u8 read_backup(u32 address)
{
  u8 value = 0;

  if(backup_type == BACKUP_NONE)
    backup_type = BACKUP_SRAM;

  if(backup_type == BACKUP_SRAM)
  {
    value = gamepak_backup[address];
  }
  else

  if(flash_mode == FLASH_ID_MODE)
  {

    if(address == 0x0000)
      value = flash_manufacturer_id;
    else


    if(address == 0x0001)
      value = flash_device_id;
  }
  else
  {
    value = flash_bank_ptr[address];
  }

  return value;
}

typedef enum
{
  EEPROM_512_BYTE,
  EEPROM_8_KBYTE
} eeprom_size_type;

typedef enum
{
  EEPROM_BASE_MODE,
  EEPROM_READ_MODE,
  EEPROM_READ_HEADER_MODE,
  EEPROM_ADDRESS_MODE,
  EEPROM_WRITE_MODE,
  EEPROM_WRITE_ADDRESS_MODE,
  EEPROM_ADDRESS_FOOTER_MODE,
  EEPROM_WRITE_FOOTER_MODE
} eeprom_mode_type;


eeprom_size_type eeprom_size = EEPROM_512_BYTE;
eeprom_mode_type eeprom_mode = EEPROM_BASE_MODE;
u32 eeprom_address_length;
u32 eeprom_address = 0;
s32 eeprom_counter = 0;
u8 eeprom_buffer[8];


void function_cc write_eeprom(u32 address, u32 value)
{
  switch(eeprom_mode)
  {
    case EEPROM_BASE_MODE:
      backup_type = BACKUP_EEPROM;
      eeprom_buffer[0] |= (value & 0x01) << (1 - eeprom_counter);
      eeprom_counter++;
      if(eeprom_counter == 2)
      {
        if(eeprom_size == EEPROM_512_BYTE)
          eeprom_address_length = 6;
        else
          eeprom_address_length = 14;

        eeprom_counter = 0;

        switch(eeprom_buffer[0] & 0x03)
        {
          case 0x02:
            eeprom_mode = EEPROM_WRITE_ADDRESS_MODE;
            break;

          case 0x03:
            eeprom_mode = EEPROM_ADDRESS_MODE;
            break;
        }
        address16(eeprom_buffer, 0) = 0;
      }
      break;

    case EEPROM_ADDRESS_MODE:
    case EEPROM_WRITE_ADDRESS_MODE:
      eeprom_buffer[eeprom_counter / 8]
       |= (value & 0x01) << (7 - (eeprom_counter % 8));
      eeprom_counter++;
      if(eeprom_counter == eeprom_address_length)
      {
        if(eeprom_size == EEPROM_512_BYTE)
        {
          eeprom_address =
           (address16(eeprom_buffer, 0) >> 2) * 8;
        }
        else
        {
          eeprom_address = (((u32)eeprom_buffer[1] >> 2) |
           ((u32)eeprom_buffer[0] << 6)) * 8;
        }

        address16(eeprom_buffer, 0) = 0;
        eeprom_counter = 0;

        if(eeprom_mode == EEPROM_ADDRESS_MODE)
        {
          eeprom_mode = EEPROM_ADDRESS_FOOTER_MODE;
        }
        else
        {
          eeprom_mode = EEPROM_WRITE_MODE;
          memset(gamepak_backup + eeprom_address, 0, 8);
        }
      }
      break;

    case EEPROM_WRITE_MODE:
      gamepak_backup[eeprom_address + (eeprom_counter / 8)] |=
       (value & 0x01) << (7 - (eeprom_counter % 8));
      eeprom_counter++;
      if(eeprom_counter == 64)
      {
        eeprom_counter = 0;
        eeprom_mode = EEPROM_WRITE_FOOTER_MODE;
      }
      break;

    case EEPROM_ADDRESS_FOOTER_MODE:
    case EEPROM_WRITE_FOOTER_MODE:
      eeprom_counter = 0;
      if(eeprom_mode == EEPROM_ADDRESS_FOOTER_MODE)
      {
        eeprom_mode = EEPROM_READ_HEADER_MODE;
      }
      else
      {
        eeprom_mode = EEPROM_BASE_MODE;
      }
      break;

    default:
      break;
  }
}

u32 function_cc read_eeprom(void)
{
  u32 value;

  switch(eeprom_mode)
  {
    case EEPROM_BASE_MODE:
      value = 1;
      break;

    case EEPROM_READ_MODE:
      value = (gamepak_backup[eeprom_address + (eeprom_counter / 8)] >>
       (7 - (eeprom_counter % 8))) & 0x01;
      eeprom_counter++;
      if(eeprom_counter == 64)
      {
        eeprom_counter = 0;
        eeprom_mode = EEPROM_BASE_MODE;
      }
      break;

    case EEPROM_READ_HEADER_MODE:
      value = 0;
      eeprom_counter++;
      if(eeprom_counter == 4)
      {
        eeprom_mode = EEPROM_READ_MODE;
        eeprom_counter = 0;
      }
      break;

    default:
      value = 0;
      break;
  }

  return value;
}

static cpu_alert_type trigger_dma(u32 dma_number, u32 value)
{
  if(value & 0x8000)
  {
    if(dma[dma_number].start_type == DMA_INACTIVE)
    {
      u32 start_type = (value >> 12) & 0x03;
      u32 dest_address = address32(io_registers, (dma_number * 12) + 0xB4) &
       0xFFFFFFF;

      dma[dma_number].dma_channel = dma_number;
      dma[dma_number].source_address =
       address32(io_registers, (dma_number * 12) + 0xB0) & 0xFFFFFFF;
      dma[dma_number].dest_address = dest_address;
      dma[dma_number].source_direction = (value >> 7) & 0x03;
      dma[dma_number].repeat_type = (value >> 9) & 0x01;
      dma[dma_number].start_type = start_type;
      dma[dma_number].irq = (value >> 14) & 0x01;


      if((dma_number >= 1) && (dma_number <= 2) &&
       (start_type == DMA_START_SPECIAL))
      {
        dma[dma_number].length_type = DMA_32BIT;
        dma[dma_number].length = 4;
        dma[dma_number].dest_direction = DMA_FIXED;
        if(dest_address == 0x40000A4)
          dma[dma_number].direct_sound_channel = DMA_DIRECT_SOUND_B;
        else
          dma[dma_number].direct_sound_channel = DMA_DIRECT_SOUND_A;
      }
      else
      {
        u32 length = address16(io_registers, (dma_number * 12) + 0xB8);

        if((dma_number == 3) && ((dest_address >> 24) == 0x0D) &&
         ((length & 0x1F) == 17))
          eeprom_size = EEPROM_8_KBYTE;

        if(dma_number < 3)
          length &= 0x3FFF;

        if(length == 0)
        {
          if(dma_number == 3)
            length = 0x10000;
          else
            length = 0x04000;
        }

        dma[dma_number].length = length;
        dma[dma_number].length_type = (value >> 10) & 0x01;
        dma[dma_number].dest_direction = (value >> 5) & 0x03;
      }

      address16(io_registers, (dma_number * 12) + 0xBA) = value;
      if(start_type == DMA_START_IMMEDIATELY)
        return dma_transfer(dma + dma_number);
    }
  }
  else
  {
    dma[dma_number].start_type = DMA_INACTIVE;
    dma[dma_number].direct_sound_channel = DMA_NO_DIRECT_SOUND;
    address16(io_registers, (dma_number * 12) + 0xBA) = value;
  }

  return CPU_ALERT_NONE;
}

cpu_alert_type function_cc write_io_register8(u32 address, u32 value)
{
  switch(address)
  {
    case 0x00:
    {
      u32 dispcnt = io_registers[REG_DISPCNT];

      if((value & 0x07) != (dispcnt & 0x07))
        oam_update = 1;

      address8(io_registers, 0x00) = value;
      break;
    }


    case 0x04:
      address8(io_registers, 0x04) =
       (address8(io_registers, 0x04) & 0x07) | (value & ~0x07);
      break;


    case 0x06:
    case 0x07:
      break;


    case 0x28:
      value = ((address8(io_registers, 0x28 + 1)) << 8) | value;
      value = ((address16(io_registers, 0x28 + 2)) << 16) | value;
      affine_reference_x[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x28) = value;
      break;

    case 0x29:
      value = (value << 8) | (address8(io_registers, 0x28));
      value = ((address16(io_registers, 0x28 + 2)) << 16) | value;
      affine_reference_x[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x28) = value;
      break;

    case 0x2A:
      value = ((address8(io_registers, 0x2A + 1)) << 8) | value;
      value = (value << 16) | (address16(io_registers, 0x28));
      affine_reference_x[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x28) = value;
      break;

    case 0x2B:
      value = (value << 8) | (address8(io_registers, 0x2A));
      value = (value << 16) | (address16(io_registers, 0x28));
      affine_reference_x[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x28) = value;
      break;


    case 0x2C:
      value = ((address8(io_registers, 0x2C + 1)) << 8) | value;
      value = ((address16(io_registers, 0x2C + 2)) << 16) | value;
      affine_reference_y[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x2C) = value;
      break;

    case 0x2D:
      value = (value << 8) | (address8(io_registers, 0x2C));
      value = ((address16(io_registers, 0x2C + 2)) << 16) | value;
      affine_reference_y[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x2C) = value;
      break;

    case 0x2E:
      value = ((address8(io_registers, 0x2E + 1)) << 8) | value;
      value = (value << 16) | (address16(io_registers, 0x2C));
      affine_reference_y[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x2C) = value;
      break;

    case 0x2F:
      value = (value << 8) | (address8(io_registers, 0x2E));
      value = (value << 16) | (address16(io_registers, 0x2C));
      affine_reference_y[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x2C) = value;
      break;


    case 0x38:
      value = ((address8(io_registers, 0x38 + 1)) << 8) | value;
      value = ((address16(io_registers, 0x38 + 2)) << 16) | value;
      affine_reference_x[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x38) = value;
      break;

    case 0x39:
      value = (value << 8) | (address8(io_registers, 0x38));
      value = ((address16(io_registers, 0x38 + 2)) << 16) | value;
      affine_reference_x[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x38) = value;
      break;

    case 0x3A:
      value = ((address8(io_registers, 0x3A + 1)) << 8) | value;
      value = (value << 16) | (address16(io_registers, 0x38));
      affine_reference_x[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x38) = value;
      break;

    case 0x3B:
      value = (value << 8) | (address8(io_registers, 0x3A));
      value = (value << 16) | (address16(io_registers, 0x38));
      affine_reference_x[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x38) = value;
      break;


    case 0x3C:
      value = ((address8(io_registers, 0x3C + 1)) << 8) | value;
      value = ((address16(io_registers, 0x3C + 2)) << 16) | value;
      affine_reference_y[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x3C) = value;
      break;

    case 0x3D:
      value = (value << 8) | (address8(io_registers, 0x3C));
      value = ((address16(io_registers, 0x3C + 2)) << 16) | value;
      affine_reference_y[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x3C) = value;
      break;

    case 0x3E:
      value = ((address8(io_registers, 0x3E + 1)) << 8) | value;
      value = (value << 16) | (address16(io_registers, 0x3C));
      affine_reference_y[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x3C) = value;
      break;

    case 0x3F:
      value = (value << 8) | (address8(io_registers, 0x3E));
      value = (value << 16) | (address16(io_registers, 0x3C));
      affine_reference_y[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x3C) = value;
      break;


    case 0x60:
      value = ((address8(io_registers, 0x60 + 1)) << 8) | value;
      { u32 sweep_ticks = ((value >> 4) & 0x07) * 2; gbc_sound_channel[0].sweep_shift = value & 0x07; gbc_sound_channel[0].sweep_direction = (value >> 3) & 0x01; gbc_sound_channel[0].sweep_status = (value != 8); gbc_sound_channel[0].sweep_ticks = sweep_ticks; gbc_sound_channel[0].sweep_initial_ticks = sweep_ticks; gbc_sound_update = 1; address16(io_registers, 0x60) = value; };
      break;

    case 0x61:
      value = ((address8(io_registers, 0x60 + 1)) << 8) | value;
      { u32 sweep_ticks = ((value >> 4) & 0x07) * 2; gbc_sound_channel[0].sweep_shift = value & 0x07; gbc_sound_channel[0].sweep_direction = (value >> 3) & 0x01; gbc_sound_channel[0].sweep_status = (value != 8); gbc_sound_channel[0].sweep_ticks = sweep_ticks; gbc_sound_channel[0].sweep_initial_ticks = sweep_ticks; gbc_sound_update = 1; address16(io_registers, 0x60) = value; };
      break;


    case 0x62:
      value = ((address8(io_registers, 0x62 + 1)) << 8) | value;
      { u32 initial_volume = (value >> 12) & 0x0F; u32 envelope_ticks = ((value >> 8) & 0x07) * 4; gbc_sound_channel[0].length_ticks = 64 - (value & 0x3F); gbc_sound_channel[0].sample_data = square_pattern_duty[(value >> 6) & 0x03]; gbc_sound_channel[0].envelope_direction = (value >> 11) & 0x01; gbc_sound_channel[0].envelope_initial_volume = initial_volume; gbc_sound_channel[0].envelope_volume = initial_volume; gbc_sound_channel[0].envelope_initial_ticks = envelope_ticks; gbc_sound_channel[0].envelope_ticks = envelope_ticks; gbc_sound_channel[0].envelope_status = (envelope_ticks != 0); gbc_sound_channel[0].envelope_volume = initial_volume; gbc_sound_update = 1; address16(io_registers, 0x62) = value; };
      break;

    case 0x63:
      value = (value << 8) | (address8(io_registers, 0x62));
      { u32 initial_volume = (value >> 12) & 0x0F; u32 envelope_ticks = ((value >> 8) & 0x07) * 4; gbc_sound_channel[0].length_ticks = 64 - (value & 0x3F); gbc_sound_channel[0].sample_data = square_pattern_duty[(value >> 6) & 0x03]; gbc_sound_channel[0].envelope_direction = (value >> 11) & 0x01; gbc_sound_channel[0].envelope_initial_volume = initial_volume; gbc_sound_channel[0].envelope_volume = initial_volume; gbc_sound_channel[0].envelope_initial_ticks = envelope_ticks; gbc_sound_channel[0].envelope_ticks = envelope_ticks; gbc_sound_channel[0].envelope_status = (envelope_ticks != 0); gbc_sound_channel[0].envelope_volume = initial_volume; gbc_sound_update = 1; address16(io_registers, 0x62) = value; };
      break;


    case 0x64:
      value = ((address8(io_registers, 0x64 + 1)) << 8) | value;
      { u32 rate = value & 0x7FF; gbc_sound_channel[0].rate = rate; gbc_sound_channel[0].frequency_step = float_to_fp16_16(((131072.0 / (2048 - rate)) * 8.0) / sound_frequency); gbc_sound_channel[0].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[0].active_flag = 1; gbc_sound_channel[0].sample_index -= float_to_fp16_16(1.0 / 12.0); gbc_sound_channel[0].envelope_ticks = gbc_sound_channel[0].envelope_initial_ticks; gbc_sound_channel[0].envelope_volume = gbc_sound_channel[0].envelope_initial_volume; } gbc_sound_update = 1; address16(io_registers, 0x64) = value; };
      break;

    case 0x65:
      value = (value << 8) | (address8(io_registers, 0x64));
      { u32 rate = value & 0x7FF; gbc_sound_channel[0].rate = rate; gbc_sound_channel[0].frequency_step = float_to_fp16_16(((131072.0 / (2048 - rate)) * 8.0) / sound_frequency); gbc_sound_channel[0].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[0].active_flag = 1; gbc_sound_channel[0].sample_index -= float_to_fp16_16(1.0 / 12.0); gbc_sound_channel[0].envelope_ticks = gbc_sound_channel[0].envelope_initial_ticks; gbc_sound_channel[0].envelope_volume = gbc_sound_channel[0].envelope_initial_volume; } gbc_sound_update = 1; address16(io_registers, 0x64) = value; };
      break;


    case 0x68:
      value = ((address8(io_registers, 0x68 + 1)) << 8) | value;
      { u32 initial_volume = (value >> 12) & 0x0F; u32 envelope_ticks = ((value >> 8) & 0x07) * 4; gbc_sound_channel[1].length_ticks = 64 - (value & 0x3F); gbc_sound_channel[1].sample_data = square_pattern_duty[(value >> 6) & 0x03]; gbc_sound_channel[1].envelope_direction = (value >> 11) & 0x01; gbc_sound_channel[1].envelope_initial_volume = initial_volume; gbc_sound_channel[1].envelope_volume = initial_volume; gbc_sound_channel[1].envelope_initial_ticks = envelope_ticks; gbc_sound_channel[1].envelope_ticks = envelope_ticks; gbc_sound_channel[1].envelope_status = (envelope_ticks != 0); gbc_sound_channel[1].envelope_volume = initial_volume; gbc_sound_update = 1; address16(io_registers, 0x68) = value; };
      break;

    case 0x69:
      value = (value << 8) | (address8(io_registers, 0x68));
      { u32 initial_volume = (value >> 12) & 0x0F; u32 envelope_ticks = ((value >> 8) & 0x07) * 4; gbc_sound_channel[1].length_ticks = 64 - (value & 0x3F); gbc_sound_channel[1].sample_data = square_pattern_duty[(value >> 6) & 0x03]; gbc_sound_channel[1].envelope_direction = (value >> 11) & 0x01; gbc_sound_channel[1].envelope_initial_volume = initial_volume; gbc_sound_channel[1].envelope_volume = initial_volume; gbc_sound_channel[1].envelope_initial_ticks = envelope_ticks; gbc_sound_channel[1].envelope_ticks = envelope_ticks; gbc_sound_channel[1].envelope_status = (envelope_ticks != 0); gbc_sound_channel[1].envelope_volume = initial_volume; gbc_sound_update = 1; address16(io_registers, 0x68) = value; };
      break;


    case 0x6C:
      value = ((address8(io_registers, 0x6C + 1)) << 8) | value;
      { u32 rate = value & 0x7FF; gbc_sound_channel[1].rate = rate; gbc_sound_channel[1].frequency_step = float_to_fp16_16(((131072.0 / (2048 - rate)) * 8.0) / sound_frequency); gbc_sound_channel[1].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[1].active_flag = 1; gbc_sound_channel[1].sample_index -= float_to_fp16_16(1.0 / 12.0); gbc_sound_channel[1].envelope_ticks = gbc_sound_channel[1].envelope_initial_ticks; gbc_sound_channel[1].envelope_volume = gbc_sound_channel[1].envelope_initial_volume; } gbc_sound_update = 1; address16(io_registers, 0x6C) = value; };
      break;

    case 0x6D:
      value = (value << 8) | (address8(io_registers, 0x6C));
      { u32 rate = value & 0x7FF; gbc_sound_channel[1].rate = rate; gbc_sound_channel[1].frequency_step = float_to_fp16_16(((131072.0 / (2048 - rate)) * 8.0) / sound_frequency); gbc_sound_channel[1].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[1].active_flag = 1; gbc_sound_channel[1].sample_index -= float_to_fp16_16(1.0 / 12.0); gbc_sound_channel[1].envelope_ticks = gbc_sound_channel[1].envelope_initial_ticks; gbc_sound_channel[1].envelope_volume = gbc_sound_channel[1].envelope_initial_volume; } gbc_sound_update = 1; address16(io_registers, 0x6C) = value; };
      break;


    case 0x70:
      value = ((address8(io_registers, 0x70 + 1)) << 8) | value;
      { gbc_sound_channel[2].wave_type = (value >> 5) & 0x01; gbc_sound_channel[2].wave_bank = (value >> 6) & 0x01; gbc_sound_channel[2].master_enable = 0; if(value & 0x80) gbc_sound_channel[2].master_enable = 1; gbc_sound_update = 1; address16(io_registers, 0x70) = value; };
      break;

    case 0x71:
      value = (value << 8) | (address8(io_registers, 0x70));
      { gbc_sound_channel[2].wave_type = (value >> 5) & 0x01; gbc_sound_channel[2].wave_bank = (value >> 6) & 0x01; gbc_sound_channel[2].master_enable = 0; if(value & 0x80) gbc_sound_channel[2].master_enable = 1; gbc_sound_update = 1; address16(io_registers, 0x70) = value; };
      break;


    case 0x72:
      value = ((address8(io_registers, 0x72 + 1)) << 8) | value;
      { gbc_sound_channel[2].length_ticks = 256 - (value & 0xFF); if((value >> 15) & 0x01) gbc_sound_channel[2].wave_volume = 12288; else gbc_sound_channel[2].wave_volume = gbc_sound_wave_volume[(value >> 13) & 0x03]; gbc_sound_update = 1; address16(io_registers, 0x72) = value; };
      break;

    case 0x73:
      value = (value << 8) | (address8(io_registers, 0x72));
      { gbc_sound_channel[2].length_ticks = 256 - (value & 0xFF); if((value >> 15) & 0x01) gbc_sound_channel[2].wave_volume = 12288; else gbc_sound_channel[2].wave_volume = gbc_sound_wave_volume[(value >> 13) & 0x03]; gbc_sound_update = 1; address16(io_registers, 0x72) = value; };
      break;


    case 0x74:
      value = ((address8(io_registers, 0x74 + 1)) << 8) | value;
      { u32 rate = value & 0x7FF; gbc_sound_channel[2].rate = rate; gbc_sound_channel[2].frequency_step = float_to_fp16_16((2097152.0 / (2048 - rate)) / sound_frequency); gbc_sound_channel[2].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[2].sample_index = 0; gbc_sound_channel[2].active_flag = 1; } gbc_sound_update = 1; address16(io_registers, 0x74) = value; };
      break;

    case 0x75:
      value = (value << 8) | (address8(io_registers, 0x74));
      { u32 rate = value & 0x7FF; gbc_sound_channel[2].rate = rate; gbc_sound_channel[2].frequency_step = float_to_fp16_16((2097152.0 / (2048 - rate)) / sound_frequency); gbc_sound_channel[2].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[2].sample_index = 0; gbc_sound_channel[2].active_flag = 1; } gbc_sound_update = 1; address16(io_registers, 0x74) = value; };
      break;


    case 0x78:
      value = ((address8(io_registers, 0x78 + 1)) << 8) | value;
      { u32 initial_volume = (value >> 12) & 0x0F; u32 envelope_ticks = ((value >> 8) & 0x07) * 4; gbc_sound_channel[3].length_ticks = 64 - (value & 0x3F); gbc_sound_channel[3].sample_data = square_pattern_duty[(value >> 6) & 0x03]; gbc_sound_channel[3].envelope_direction = (value >> 11) & 0x01; gbc_sound_channel[3].envelope_initial_volume = initial_volume; gbc_sound_channel[3].envelope_volume = initial_volume; gbc_sound_channel[3].envelope_initial_ticks = envelope_ticks; gbc_sound_channel[3].envelope_ticks = envelope_ticks; gbc_sound_channel[3].envelope_status = (envelope_ticks != 0); gbc_sound_channel[3].envelope_volume = initial_volume; gbc_sound_update = 1; address16(io_registers, 0x78) = value; };
      break;

    case 0x79:
      value = (value << 8) | (address8(io_registers, 0x78));
      { u32 initial_volume = (value >> 12) & 0x0F; u32 envelope_ticks = ((value >> 8) & 0x07) * 4; gbc_sound_channel[3].length_ticks = 64 - (value & 0x3F); gbc_sound_channel[3].sample_data = square_pattern_duty[(value >> 6) & 0x03]; gbc_sound_channel[3].envelope_direction = (value >> 11) & 0x01; gbc_sound_channel[3].envelope_initial_volume = initial_volume; gbc_sound_channel[3].envelope_volume = initial_volume; gbc_sound_channel[3].envelope_initial_ticks = envelope_ticks; gbc_sound_channel[3].envelope_ticks = envelope_ticks; gbc_sound_channel[3].envelope_status = (envelope_ticks != 0); gbc_sound_channel[3].envelope_volume = initial_volume; gbc_sound_update = 1; address16(io_registers, 0x78) = value; };
      break;


    case 0x7C:
      value = ((address8(io_registers, 0x7C + 1)) << 8) | value;
      { u32 dividing_ratio = value & 0x07; u32 frequency_shift = (value >> 4) & 0x0F; if(dividing_ratio == 0) { gbc_sound_channel[3].frequency_step = float_to_fp16_16(1048576.0 / (1 << (frequency_shift + 1)) / sound_frequency); } else { gbc_sound_channel[3].frequency_step = float_to_fp16_16(524288.0 / (dividing_ratio * (1 << (frequency_shift + 1))) / sound_frequency); } gbc_sound_channel[3].noise_type = (value >> 3) & 0x01; gbc_sound_channel[3].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[3].sample_index = 0; gbc_sound_channel[3].active_flag = 1; gbc_sound_channel[3].envelope_ticks = gbc_sound_channel[3].envelope_initial_ticks; gbc_sound_channel[3].envelope_volume = gbc_sound_channel[3].envelope_initial_volume; } gbc_sound_update = 1; address16(io_registers, 0x7C) = value; };
      break;

    case 0x7D:
      value = (value << 8) | (address8(io_registers, 0x7C));
      { u32 dividing_ratio = value & 0x07; u32 frequency_shift = (value >> 4) & 0x0F; if(dividing_ratio == 0) { gbc_sound_channel[3].frequency_step = float_to_fp16_16(1048576.0 / (1 << (frequency_shift + 1)) / sound_frequency); } else { gbc_sound_channel[3].frequency_step = float_to_fp16_16(524288.0 / (dividing_ratio * (1 << (frequency_shift + 1))) / sound_frequency); } gbc_sound_channel[3].noise_type = (value >> 3) & 0x01; gbc_sound_channel[3].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[3].sample_index = 0; gbc_sound_channel[3].active_flag = 1; gbc_sound_channel[3].envelope_ticks = gbc_sound_channel[3].envelope_initial_ticks; gbc_sound_channel[3].envelope_volume = gbc_sound_channel[3].envelope_initial_volume; } gbc_sound_update = 1; address16(io_registers, 0x7C) = value; };
      break;


    case 0x80:
      value = ((address8(io_registers, 0x80 + 1)) << 8) | value;
      gbc_trigger_sound(value);
      break;

    case 0x81:
      value = (value << 8) | (address8(io_registers, 0x80));
      gbc_trigger_sound(value);
      break;


    case 0x82:
      value = ((address8(io_registers, 0x82 + 1)) << 8) | value;
      { timer[0].direct_sound_channels = (((value >> 10) & 0x01) == 0) | ((((value >> 14) & 0x01) == 0) << 1); timer[1].direct_sound_channels = (((value >> 10) & 0x01) == 1) | ((((value >> 14) & 0x01) == 1) << 1); direct_sound_channel[0].volume = (value >> 2) & 0x01; direct_sound_channel[0].status = (value >> 8) & 0x03; direct_sound_channel[1].volume = (value >> 3) & 0x01; direct_sound_channel[1].status = (value >> 12) & 0x03; gbc_sound_master_volume = value & 0x03; if((value >> 11) & 0x01) sound_reset_fifo(0); if((value >> 15) & 0x01) sound_reset_fifo(1); address16(io_registers, 0x82) = value; };
      break;

    case 0x83:
      value = (value << 8) | (address8(io_registers, 0x82));
      { timer[0].direct_sound_channels = (((value >> 10) & 0x01) == 0) | ((((value >> 14) & 0x01) == 0) << 1); timer[1].direct_sound_channels = (((value >> 10) & 0x01) == 1) | ((((value >> 14) & 0x01) == 1) << 1); direct_sound_channel[0].volume = (value >> 2) & 0x01; direct_sound_channel[0].status = (value >> 8) & 0x03; direct_sound_channel[1].volume = (value >> 3) & 0x01; direct_sound_channel[1].status = (value >> 12) & 0x03; gbc_sound_master_volume = value & 0x03; if((value >> 11) & 0x01) sound_reset_fifo(0); if((value >> 15) & 0x01) sound_reset_fifo(1); address16(io_registers, 0x82) = value; };
      break;


    case 0x84:
      sound_control_x(value);
      break;


    case 0x90 ... 0x9F:
      gbc_sound_wave_update = 1;
      address8(io_registers, address) = value;
      break;


    case 0xA0:
      sound_timer_queue8(0, value);
      break;


    case 0xA4:
      sound_timer_queue8(1, value);
      break;


    case 0xBB:
      value = ((address8(io_registers, 0xBA + 1)) << 8) | value;
      return trigger_dma(0, value);

    case 0xC7:
      value = ((address8(io_registers, 0xC6 + 1)) << 8) | value;
      return trigger_dma(1, value);

    case 0xD3:
      value = ((address8(io_registers, 0xD2 + 1)) << 8) | value;
      return trigger_dma(2, value);

    case 0xDF:
      value = ((address8(io_registers, 0xDE + 1)) << 8) | value;
      return trigger_dma(3, value);


    case 0x100:
      value = ((address8(io_registers, 0x100 + 1)) << 8) | value;
      timer[0].reload = 0x10000 - value; if(0 < 2) { u32 timer_reload = timer[0].reload << timer[0].prescale; timer[0].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;

    case 0x101:
      value = (value << 8) | (address8(io_registers, 0x100));
      timer[0].reload = 0x10000 - value; if(0 < 2) { u32 timer_reload = timer[0].reload << timer[0].prescale; timer[0].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;

    case 0x104:
      value = ((address8(io_registers, 0x104 + 1)) << 8) | value;
      timer[1].reload = 0x10000 - value; if(1 < 2) { u32 timer_reload = timer[1].reload << timer[1].prescale; timer[1].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;

    case 0x105:
      value = (value << 8) | (address8(io_registers, 0x104));
      timer[1].reload = 0x10000 - value; if(1 < 2) { u32 timer_reload = timer[1].reload << timer[1].prescale; timer[1].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;

    case 0x108:
      value = ((address8(io_registers, 0x108 + 1)) << 8) | value;
      timer[2].reload = 0x10000 - value; if(2 < 2) { u32 timer_reload = timer[2].reload << timer[2].prescale; timer[2].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;

    case 0x109:
      value = (value << 8) | (address8(io_registers, 0x108));
      timer[2].reload = 0x10000 - value; if(2 < 2) { u32 timer_reload = timer[2].reload << timer[2].prescale; timer[2].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;

    case 0x10C:
      value = ((address8(io_registers, 0x10C + 1)) << 8) | value;
      timer[3].reload = 0x10000 - value; if(3 < 2) { u32 timer_reload = timer[3].reload << timer[3].prescale; timer[3].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;

    case 0x10D:
      value = (value << 8) | (address8(io_registers, 0x10C));
      timer[3].reload = 0x10000 - value; if(3 < 2) { u32 timer_reload = timer[3].reload << timer[3].prescale; timer[3].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;


    case 0x103:
      value = ((address8(io_registers, 0x102 + 1)) << 8) | value;
      trigger_timer(0, value);
      break;

    case 0x107:
      value = ((address8(io_registers, 0x106 + 1)) << 8) | value;
      trigger_timer(1, value);
      break;

    case 0x10B:
      value = ((address8(io_registers, 0x10A + 1)) << 8) | value;
      trigger_timer(2, value);
      break;

    case 0x10F:
      value = ((address8(io_registers, 0x10E + 1)) << 8) | value;
      trigger_timer(3, value);
      break;


    case 0x202:
      address8(io_registers, 0x202) &= ~value;
      break;

    case 0x203:
      address8(io_registers, 0x203) &= ~value;
      break;


    case 0x301:
      if((value & 0x01) == 0)
        reg[CPU_HALT_STATE] = CPU_HALT;
      else
        reg[CPU_HALT_STATE] = CPU_STOP;

      return CPU_ALERT_HALT;
      break;

    default:
      address8(io_registers, address) = value;
      break;
  }

  return CPU_ALERT_NONE;
}

cpu_alert_type function_cc write_io_register16(u32 address, u32 value)
{
  switch(address)
  {
    case 0x00:
    {
      u32 dispcnt = io_registers[REG_DISPCNT];
      if((value & 0x07) != (dispcnt & 0x07))
        oam_update = 1;

      address16(io_registers, 0x00) = value;
      break;
    }


    case 0x04:
      address16(io_registers, 0x04) =
       (address16(io_registers, 0x04) & 0x07) | (value & ~0x07);
      break;


    case 0x06:
      break;


    case 0x28:
      value = ((address16(io_registers, 0x28 + 2)) << 16) | value;
      affine_reference_x[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x28) = value;
      break;

    case 0x2A:
      value = (value << 16) | (address16(io_registers, 0x28));
      affine_reference_x[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x28) = value;
      break;


    case 0x2C:
      value = ((address16(io_registers, 0x2C + 2)) << 16) | value;
      affine_reference_y[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x2C) = value;
      break;

    case 0x2E:
      value = (value << 16) | (address16(io_registers, 0x2C));
      affine_reference_y[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x2C) = value;
      break;



    case 0x38:
      value = ((address16(io_registers, 0x38 + 2)) << 16) | value;
      affine_reference_x[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x38) = value;
      break;

    case 0x3A:
      value = (value << 16) | (address16(io_registers, 0x38));
      affine_reference_x[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x38) = value;
      break;


    case 0x3C:
      value = ((address16(io_registers, 0x3C + 2)) << 16) | value;
      affine_reference_y[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x3C) = value;
      break;

    case 0x3E:
      value = (value << 16) | (address16(io_registers, 0x3C));
      affine_reference_y[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x3C) = value;
      break;


    case 0x60:
      { u32 sweep_ticks = ((value >> 4) & 0x07) * 2; gbc_sound_channel[0].sweep_shift = value & 0x07; gbc_sound_channel[0].sweep_direction = (value >> 3) & 0x01; gbc_sound_channel[0].sweep_status = (value != 8); gbc_sound_channel[0].sweep_ticks = sweep_ticks; gbc_sound_channel[0].sweep_initial_ticks = sweep_ticks; gbc_sound_update = 1; address16(io_registers, 0x60) = value; };
      break;


    case 0x62:
      { u32 initial_volume = (value >> 12) & 0x0F; u32 envelope_ticks = ((value >> 8) & 0x07) * 4; gbc_sound_channel[0].length_ticks = 64 - (value & 0x3F); gbc_sound_channel[0].sample_data = square_pattern_duty[(value >> 6) & 0x03]; gbc_sound_channel[0].envelope_direction = (value >> 11) & 0x01; gbc_sound_channel[0].envelope_initial_volume = initial_volume; gbc_sound_channel[0].envelope_volume = initial_volume; gbc_sound_channel[0].envelope_initial_ticks = envelope_ticks; gbc_sound_channel[0].envelope_ticks = envelope_ticks; gbc_sound_channel[0].envelope_status = (envelope_ticks != 0); gbc_sound_channel[0].envelope_volume = initial_volume; gbc_sound_update = 1; address16(io_registers, 0x62) = value; };
      break;


    case 0x64:
      { u32 rate = value & 0x7FF; gbc_sound_channel[0].rate = rate; gbc_sound_channel[0].frequency_step = float_to_fp16_16(((131072.0 / (2048 - rate)) * 8.0) / sound_frequency); gbc_sound_channel[0].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[0].active_flag = 1; gbc_sound_channel[0].sample_index -= float_to_fp16_16(1.0 / 12.0); gbc_sound_channel[0].envelope_ticks = gbc_sound_channel[0].envelope_initial_ticks; gbc_sound_channel[0].envelope_volume = gbc_sound_channel[0].envelope_initial_volume; } gbc_sound_update = 1; address16(io_registers, 0x64) = value; };
      break;


    case 0x68:
      { u32 initial_volume = (value >> 12) & 0x0F; u32 envelope_ticks = ((value >> 8) & 0x07) * 4; gbc_sound_channel[1].length_ticks = 64 - (value & 0x3F); gbc_sound_channel[1].sample_data = square_pattern_duty[(value >> 6) & 0x03]; gbc_sound_channel[1].envelope_direction = (value >> 11) & 0x01; gbc_sound_channel[1].envelope_initial_volume = initial_volume; gbc_sound_channel[1].envelope_volume = initial_volume; gbc_sound_channel[1].envelope_initial_ticks = envelope_ticks; gbc_sound_channel[1].envelope_ticks = envelope_ticks; gbc_sound_channel[1].envelope_status = (envelope_ticks != 0); gbc_sound_channel[1].envelope_volume = initial_volume; gbc_sound_update = 1; address16(io_registers, 0x68) = value; };
      break;


    case 0x6C:
      { u32 rate = value & 0x7FF; gbc_sound_channel[1].rate = rate; gbc_sound_channel[1].frequency_step = float_to_fp16_16(((131072.0 / (2048 - rate)) * 8.0) / sound_frequency); gbc_sound_channel[1].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[1].active_flag = 1; gbc_sound_channel[1].sample_index -= float_to_fp16_16(1.0 / 12.0); gbc_sound_channel[1].envelope_ticks = gbc_sound_channel[1].envelope_initial_ticks; gbc_sound_channel[1].envelope_volume = gbc_sound_channel[1].envelope_initial_volume; } gbc_sound_update = 1; address16(io_registers, 0x6C) = value; };
      break;


    case 0x70:
      { gbc_sound_channel[2].wave_type = (value >> 5) & 0x01; gbc_sound_channel[2].wave_bank = (value >> 6) & 0x01; gbc_sound_channel[2].master_enable = 0; if(value & 0x80) gbc_sound_channel[2].master_enable = 1; gbc_sound_update = 1; address16(io_registers, 0x70) = value; };
      break;


    case 0x72:
      { gbc_sound_channel[2].length_ticks = 256 - (value & 0xFF); if((value >> 15) & 0x01) gbc_sound_channel[2].wave_volume = 12288; else gbc_sound_channel[2].wave_volume = gbc_sound_wave_volume[(value >> 13) & 0x03]; gbc_sound_update = 1; address16(io_registers, 0x72) = value; };
      break;


    case 0x74:
      { u32 rate = value & 0x7FF; gbc_sound_channel[2].rate = rate; gbc_sound_channel[2].frequency_step = float_to_fp16_16((2097152.0 / (2048 - rate)) / sound_frequency); gbc_sound_channel[2].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[2].sample_index = 0; gbc_sound_channel[2].active_flag = 1; } gbc_sound_update = 1; address16(io_registers, 0x74) = value; };
      break;


    case 0x78:
      { u32 initial_volume = (value >> 12) & 0x0F; u32 envelope_ticks = ((value >> 8) & 0x07) * 4; gbc_sound_channel[3].length_ticks = 64 - (value & 0x3F); gbc_sound_channel[3].sample_data = square_pattern_duty[(value >> 6) & 0x03]; gbc_sound_channel[3].envelope_direction = (value >> 11) & 0x01; gbc_sound_channel[3].envelope_initial_volume = initial_volume; gbc_sound_channel[3].envelope_volume = initial_volume; gbc_sound_channel[3].envelope_initial_ticks = envelope_ticks; gbc_sound_channel[3].envelope_ticks = envelope_ticks; gbc_sound_channel[3].envelope_status = (envelope_ticks != 0); gbc_sound_channel[3].envelope_volume = initial_volume; gbc_sound_update = 1; address16(io_registers, 0x78) = value; };
      break;


    case 0x7C:
      { u32 dividing_ratio = value & 0x07; u32 frequency_shift = (value >> 4) & 0x0F; if(dividing_ratio == 0) { gbc_sound_channel[3].frequency_step = float_to_fp16_16(1048576.0 / (1 << (frequency_shift + 1)) / sound_frequency); } else { gbc_sound_channel[3].frequency_step = float_to_fp16_16(524288.0 / (dividing_ratio * (1 << (frequency_shift + 1))) / sound_frequency); } gbc_sound_channel[3].noise_type = (value >> 3) & 0x01; gbc_sound_channel[3].length_status = (value >> 14) & 0x01; if(value & 0x8000) { gbc_sound_channel[3].sample_index = 0; gbc_sound_channel[3].active_flag = 1; gbc_sound_channel[3].envelope_ticks = gbc_sound_channel[3].envelope_initial_ticks; gbc_sound_channel[3].envelope_volume = gbc_sound_channel[3].envelope_initial_volume; } gbc_sound_update = 1; address16(io_registers, 0x7C) = value; };
      break;


    case 0x80:
      gbc_trigger_sound(value);
      break;


    case 0x82:
      { timer[0].direct_sound_channels = (((value >> 10) & 0x01) == 0) | ((((value >> 14) & 0x01) == 0) << 1); timer[1].direct_sound_channels = (((value >> 10) & 0x01) == 1) | ((((value >> 14) & 0x01) == 1) << 1); direct_sound_channel[0].volume = (value >> 2) & 0x01; direct_sound_channel[0].status = (value >> 8) & 0x03; direct_sound_channel[1].volume = (value >> 3) & 0x01; direct_sound_channel[1].status = (value >> 12) & 0x03; gbc_sound_master_volume = value & 0x03; if((value >> 11) & 0x01) sound_reset_fifo(0); if((value >> 15) & 0x01) sound_reset_fifo(1); address16(io_registers, 0x82) = value; };
      break;


    case 0x84:
      sound_control_x(value);
      break;


    case 0x90 ... 0x9E:
      gbc_sound_wave_update = 1;
      address16(io_registers, address) = value;
      break;


    case 0xA0:
      sound_timer_queue16(0, value);
      break;


    case 0xA4:
      sound_timer_queue16(1, value);
      break;


    case 0xBA:
      return trigger_dma(0, value);

    case 0xC6:
      return trigger_dma(1, value);

    case 0xD2:
      return trigger_dma(2, value);

    case 0xDE:
      return trigger_dma(3, value);


    case 0x100:
      timer[0].reload = 0x10000 - value; if(0 < 2) { u32 timer_reload = timer[0].reload << timer[0].prescale; timer[0].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;

    case 0x104:
      timer[1].reload = 0x10000 - value; if(1 < 2) { u32 timer_reload = timer[1].reload << timer[1].prescale; timer[1].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;

    case 0x108:
      timer[2].reload = 0x10000 - value; if(2 < 2) { u32 timer_reload = timer[2].reload << timer[2].prescale; timer[2].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;

    case 0x10C:
      timer[3].reload = 0x10000 - value; if(3 < 2) { u32 timer_reload = timer[3].reload << timer[3].prescale; timer[3].frequency_step = float_to_fp8_24(GBC_BASE_RATE / (timer_reload * sound_frequency)); };
      break;


    case 0x102:
      trigger_timer(0, value);
      break;


    case 0x106:
      trigger_timer(1, value);
      break;


    case 0x10A:
      trigger_timer(2, value);
      break;


    case 0x10E:
      trigger_timer(3, value);
      break;


    case 0x130:
      break;


    case 0x202:
      address16(io_registers, 0x202) &= ~value;
      break;


    case 0x204:
      break;


    case 0x300:
      if(((value >> 8) & 0x01) == 0)
        reg[CPU_HALT_STATE] = CPU_HALT;
      else
        reg[CPU_HALT_STATE] = CPU_STOP;

      return CPU_ALERT_HALT;

    default:
      address16(io_registers, address) = value;
      break;
  }

  return CPU_ALERT_NONE;
}


cpu_alert_type function_cc write_io_register32(u32 address, u32 value)
{
  switch(address)
  {

    case 0x28:
      affine_reference_x[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x28) = value;
      break;


    case 0x2C:
      affine_reference_y[0] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x2C) = value;
      break;


    case 0x38:
      affine_reference_x[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x38) = value;
      break;


    case 0x3C:
      affine_reference_y[1] = (s32)(value << 4) >> 4;
      address32(io_registers, 0x3C) = value;
      break;


    case 0xA0:
      sound_timer_queue32(0, value);
      break;


    case 0xA4:
      sound_timer_queue32(1, value);
      break;

    default:
    {
      cpu_alert_type alert_low =
        write_io_register16(address, value & 0xFFFF);

      cpu_alert_type alert_high =
        write_io_register16(address + 2, value >> 16);

      if(alert_high)
        return alert_high;

      return alert_low;
    }
  }

  return CPU_ALERT_NONE;
}

void function_cc write_backup(u32 address, u32 value)
{
  value &= 0xFF;

  if(backup_type == BACKUP_NONE)
    backup_type = BACKUP_SRAM;



  if((address == 0x5555) && (flash_mode != FLASH_WRITE_MODE))
  {
    if((flash_command_position == 0) && (value == 0xAA))
    {
      backup_type = BACKUP_FLASH;
      flash_command_position = 1;
    }

    if(flash_command_position == 2)
    {
      switch(value)
      {
        case 0x90:



          if(flash_mode == FLASH_BASE_MODE)
            flash_mode = FLASH_ID_MODE;

          break;

        case 0x80:

          if(flash_mode == FLASH_BASE_MODE)
            flash_mode = FLASH_ERASE_MODE;
          break;

        case 0xF0:

          if(flash_mode == FLASH_ID_MODE)
            flash_mode = FLASH_BASE_MODE;
          break;

        case 0xA0:

          if(flash_mode == FLASH_BASE_MODE)
            flash_mode = FLASH_WRITE_MODE;
          break;

        case 0xB0:


          flash_size = FLASH_SIZE_128KB;
          if(flash_mode == FLASH_BASE_MODE)
            flash_mode = FLASH_BANKSWITCH_MODE;
          break;

        case 0x10:

          if(flash_mode == FLASH_ERASE_MODE)
          {
            if(flash_size == FLASH_SIZE_64KB)
              memset(gamepak_backup, 0xFF, 1024 * 64);
            else
              memset(gamepak_backup, 0xFF, 1024 * 128);
            flash_mode = FLASH_BASE_MODE;
          }
          break;

        default:
          break;
      }
      flash_command_position = 0;
    }
    if(backup_type == BACKUP_SRAM)
      gamepak_backup[0x5555] = value;
  }
  else

  if((address == 0x2AAA) && (value == 0x55) &&
   (flash_command_position == 1))
  {
    flash_command_position = 2;
  }
  else
  {
    if((flash_command_position == 2) &&
     (flash_mode == FLASH_ERASE_MODE) && (value == 0x30))
    {

      memset(flash_bank_ptr + (address & 0xF000), 0xFF, 1024 * 4);
      flash_mode = FLASH_BASE_MODE;
      flash_command_position = 0;
    }
    else

    if((flash_command_position == 0) &&
     (flash_mode == FLASH_BANKSWITCH_MODE) && (address == 0x0000) &&
     (flash_size == FLASH_SIZE_128KB))
    {
      flash_bank_ptr = gamepak_backup + ((value & 0x01) * (1024 * 64));
      flash_mode = FLASH_BASE_MODE;
    }
    else

    if((flash_command_position == 0) && (flash_mode == FLASH_WRITE_MODE))
    {

      flash_bank_ptr[address] = value;
      flash_mode = FLASH_BASE_MODE;
    }
    else

    if(backup_type == BACKUP_SRAM)
    {


      if(address >= 0x8000)
        sram_size = SRAM_SIZE_64KB;
      gamepak_backup[address] = value;
    }
  }
}

typedef enum
{
  RTC_DISABLED,
  RTC_IDLE,
  RTC_COMMAND,
  RTC_OUTPUT_DATA,
  RTC_INPUT_DATA
} rtc_state_type;

typedef enum
{
  RTC_COMMAND_RESET = 0x60,
  RTC_COMMAND_WRITE_STATUS = 0x62,
  RTC_COMMAND_READ_STATUS = 0x63,
  RTC_COMMAND_OUTPUT_TIME_FULL = 0x65,
  RTC_COMMAND_OUTPUT_TIME = 0x67
} rtc_command_type;

typedef enum
{
  RTC_WRITE_TIME,
  RTC_WRITE_TIME_FULL,
  RTC_WRITE_STATUS
} rtc_write_mode_type;

rtc_state_type rtc_state = RTC_DISABLED;
rtc_write_mode_type rtc_write_mode;
u8 rtc_registers[3];
u32 rtc_command;
u32 rtc_data[12];
u32 rtc_status = 0x40;
u32 rtc_data_bytes;
s32 rtc_bit_count;

u32 encode_bcd(u8 value)
{
  return ((value / 10) << 4) | (value % 10);
}

void function_cc write_rtc(u32 address, u32 value)
{
  u32 rtc_page_index;
  u32 update_address;
  u8 *map;

  value &= 0xFFFF;

  switch(address)
  {




    case 0xC4:
      if(rtc_state == RTC_DISABLED)
        rtc_state = RTC_IDLE;
      if(!(rtc_registers[0] & 0x04))
        value = (rtc_registers[0] & 0x02) | (value & ~0x02);
      if(rtc_registers[2] & 0x01)
      {


        if((rtc_state == RTC_IDLE) && (rtc_registers[0] == 0x01) &&
         (value == 0x05))
        {

          update_address = 0x80000C4 + (0 * 2); rtc_registers[0] = value; rtc_page_index = update_address >> 15; map = memory_map_read[rtc_page_index]; if(!map) map = load_gamepak_page(rtc_page_index & 0x3FF); address16(map, update_address & 0x7FFF) = value;
          rtc_state = RTC_COMMAND;
          rtc_command = 0;
          rtc_bit_count = 7;
        }
        else
        {
          update_address = 0x80000C4 + (0 * 2); rtc_registers[0] = value; rtc_page_index = update_address >> 15; map = memory_map_read[rtc_page_index]; if(!map) map = load_gamepak_page(rtc_page_index & 0x3FF); address16(map, update_address & 0x7FFF) = value;
          switch(rtc_state)
          {



            case RTC_COMMAND:
              if(rtc_registers[0] & 0x01)
              {
                rtc_command |= ((value & 0x02) >> 1) << rtc_bit_count;
                rtc_bit_count--;
              }


              if(rtc_bit_count < 0)
              {
                switch(rtc_command)
                {

                  case RTC_COMMAND_RESET:
                    rtc_state = RTC_IDLE;
                    memset(rtc_registers, 0, sizeof(rtc_registers));
                    break;


                  case RTC_COMMAND_WRITE_STATUS:
                    rtc_state = RTC_INPUT_DATA;
                    rtc_data_bytes = 1;
                    rtc_write_mode = RTC_WRITE_STATUS;
                    break;


                  case RTC_COMMAND_READ_STATUS:
                    rtc_state = RTC_OUTPUT_DATA;
                    rtc_data_bytes = 1;
                    rtc_data[0] = rtc_status;
                    break;


                  case RTC_COMMAND_OUTPUT_TIME_FULL:
                  {
                    struct tm *current_time;
                    time_t current_time_flat;
                    u32 day_of_week;

                    time(&current_time_flat);
                    current_time = localtime(&current_time_flat);

                    day_of_week = current_time->tm_wday;
                    if(day_of_week == 0)
                      day_of_week = 6;
                    else
                      day_of_week--;

                    rtc_state = RTC_OUTPUT_DATA;
                    rtc_data_bytes = 7;
                    rtc_data[0] = encode_bcd(current_time->tm_year % 100);
                    rtc_data[1] = encode_bcd(current_time->tm_mon + 1);
                    rtc_data[2] = encode_bcd(current_time->tm_mday);
                    rtc_data[3] = encode_bcd(day_of_week);
                    rtc_data[4] = encode_bcd(current_time->tm_hour);
                    rtc_data[5] = encode_bcd(current_time->tm_min);
                    rtc_data[6] = encode_bcd(current_time->tm_sec);

                    break;
                  }


                  case RTC_COMMAND_OUTPUT_TIME:
                  {
                    struct tm *current_time;
                    time_t current_time_flat;

                    time(&current_time_flat);
                    current_time = localtime(&current_time_flat);

                    rtc_state = RTC_OUTPUT_DATA;
                    rtc_data_bytes = 3;
                    rtc_data[0] = encode_bcd(current_time->tm_hour);
                    rtc_data[1] = encode_bcd(current_time->tm_min);
                    rtc_data[2] = encode_bcd(current_time->tm_sec);
                    break;
                  }
                }
                rtc_bit_count = 0;
              }
              break;



            case RTC_INPUT_DATA:

              if(rtc_registers[1] & 0x02)
              {

                if(!(value & 0x01))
                {
                  rtc_data[rtc_bit_count >> 3] |=
                   ((value & 0x01) << (7 - (rtc_bit_count & 0x07)));
                }
                else
                {
                  rtc_bit_count++;

                  if(rtc_bit_count == (rtc_data_bytes * 8))
                  {
                    rtc_state = RTC_IDLE;
                    switch(rtc_write_mode)
                    {
                      case RTC_WRITE_STATUS:
                        rtc_status = rtc_data[0];
                        break;

                      default:
                        break;
                    }
                  }
                }
              }
              break;

            case RTC_OUTPUT_DATA:

              if(!(rtc_registers[1] & 0x02))
              {

                if(!(value & 0x01))
                {
                  u8 current_output_byte = rtc_registers[2];

                  current_output_byte =
                   (current_output_byte & ~0x02) |
                   (((rtc_data[rtc_bit_count >> 3] >>
                   (rtc_bit_count & 0x07)) & 0x01) << 1);

                  update_address = 0x80000C4 + (0 * 2); rtc_registers[0] = current_output_byte; rtc_page_index = update_address >> 15; map = memory_map_read[rtc_page_index]; if(!map) map = load_gamepak_page(rtc_page_index & 0x3FF); address16(map, update_address & 0x7FFF) = current_output_byte;

                }
                else
                {
                  rtc_bit_count++;

                  if(rtc_bit_count == (rtc_data_bytes * 8))
                  {
                    rtc_state = RTC_IDLE;
                    memset(rtc_registers, 0, sizeof(rtc_registers));
                  }
                }
              }
              break;

            default:
              break;
          }
        }
      }
      else
      {
        update_address = 0x80000C4 + (2 * 2); rtc_registers[2] = value; rtc_page_index = update_address >> 15; map = memory_map_read[rtc_page_index]; if(!map) map = load_gamepak_page(rtc_page_index & 0x3FF); address16(map, update_address & 0x7FFF) = value;
      }
      break;


    case 0xC6:
      update_address = 0x80000C4 + (1 * 2); rtc_registers[1] = value; rtc_page_index = update_address >> 15; map = memory_map_read[rtc_page_index]; if(!map) map = load_gamepak_page(rtc_page_index & 0x3FF); address16(map, update_address & 0x7FFF) = value;
      break;


    case 0xC8:
      update_address = 0x80000C4 + (2 * 2); rtc_registers[2] = value; rtc_page_index = update_address >> 15; map = memory_map_read[rtc_page_index]; if(!map) map = load_gamepak_page(rtc_page_index & 0x3FF); address16(map, update_address & 0x7FFF) = value;
      break;
  }
}

u8 function_cc read_memory8(u32 address)
{
  u8 value;
  switch(address >> 24) { case 0x00: if(reg[REG_PC] >= 0x4000) value = address8(&bios_read_protect, address & 0x03); else value = address8(bios_rom, address & 0x3FFF); break; case 0x02: address = (address & 0x7FFF) + ((address & 0x38000) * 2) + 0x8000; value = address8(ewram, address); break; case 0x03: value = address8(iwram, (address & 0x7FFF) + 0x8000); break; case 0x04: value = address8(io_registers, address & 0x3FF); break; case 0x05: value = address8(palette_ram, address & 0x3FF); break; case 0x06: address &= 0x1FFFF; if(address > 0x18000) address -= 0x8000; value = address8(vram, address); break; case 0x07: value = address8(oam_ram, address & 0x3FF); break; case 0x08: case 0x09: case 0x0A: case 0x0B: case 0x0C: if((address & 0x1FFFFFF) >= gamepak_size) { value = 0; } else { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address8(map, address & 0x7FFF); } break; case 0x0D: if((address & 0x1FFFFFF) < gamepak_size) { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address8(map, address & 0x7FFF); } else value = read_eeprom(); break; case 0x0E: case 0x0F: value = read_backup(address & 0xFFFF); break; default: if(!(reg[REG_CPSR] & 0x20)) value = read_memory8(reg[REG_PC] + 4 + (address & 0x03)); else value = read_memory8(reg[REG_PC] + 2 + (address & 0x01)); break; };
  return value;
}

u16 function_cc read_memory16_signed(u32 address)
{
  u16 value;

  if(address & 0x01)
  {
    return (s8)read_memory8(address);
  }
  else
  {
    switch(address >> 24) { case 0x00: if(reg[REG_PC] >= 0x4000) value = address16(&bios_read_protect, address & 0x03); else value = address16(bios_rom, address & 0x3FFF); break; case 0x02: address = (address & 0x7FFF) + ((address & 0x38000) * 2) + 0x8000; value = address16(ewram, address); break; case 0x03: value = address16(iwram, (address & 0x7FFF) + 0x8000); break; case 0x04: value = address16(io_registers, address & 0x3FF); break; case 0x05: value = address16(palette_ram, address & 0x3FF); break; case 0x06: address &= 0x1FFFF; if(address > 0x18000) address -= 0x8000; value = address16(vram, address); break; case 0x07: value = address16(oam_ram, address & 0x3FF); break; case 0x08: case 0x09: case 0x0A: case 0x0B: case 0x0C: if((address & 0x1FFFFFF) >= gamepak_size) { value = 0; } else { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address16(map, address & 0x7FFF); } break; case 0x0D: if((address & 0x1FFFFFF) < gamepak_size) { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address16(map, address & 0x7FFF); } else value = read_eeprom(); break; case 0x0E: case 0x0F: value = 0; break; default: if(!(reg[REG_CPSR] & 0x20)) value = read_memory16(reg[REG_PC] + 4 + (address & 0x02)); else value = read_memory16(reg[REG_PC] + 2); break; };
  }

  return value;
}



u32 function_cc read_memory16(u32 address)
{
  u32 value;

  if(address & 0x01)
  {
    address &= ~0x01;
    switch(address >> 24) { case 0x00: if(reg[REG_PC] >= 0x4000) value = address16(&bios_read_protect, address & 0x03); else value = address16(bios_rom, address & 0x3FFF); break; case 0x02: address = (address & 0x7FFF) + ((address & 0x38000) * 2) + 0x8000; value = address16(ewram, address); break; case 0x03: value = address16(iwram, (address & 0x7FFF) + 0x8000); break; case 0x04: value = address16(io_registers, address & 0x3FF); break; case 0x05: value = address16(palette_ram, address & 0x3FF); break; case 0x06: address &= 0x1FFFF; if(address > 0x18000) address -= 0x8000; value = address16(vram, address); break; case 0x07: value = address16(oam_ram, address & 0x3FF); break; case 0x08: case 0x09: case 0x0A: case 0x0B: case 0x0C: if((address & 0x1FFFFFF) >= gamepak_size) { value = 0; } else { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address16(map, address & 0x7FFF); } break; case 0x0D: if((address & 0x1FFFFFF) < gamepak_size) { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address16(map, address & 0x7FFF); } else value = read_eeprom(); break; case 0x0E: case 0x0F: value = 0; break; default: if(!(reg[REG_CPSR] & 0x20)) value = read_memory16(reg[REG_PC] + 4 + (address & 0x02)); else value = read_memory16(reg[REG_PC] + 2); break; };
    ror(value, value, 8);
  }
  else
  {
    switch(address >> 24) { case 0x00: if(reg[REG_PC] >= 0x4000) value = address16(&bios_read_protect, address & 0x03); else value = address16(bios_rom, address & 0x3FFF); break; case 0x02: address = (address & 0x7FFF) + ((address & 0x38000) * 2) + 0x8000; value = address16(ewram, address); break; case 0x03: value = address16(iwram, (address & 0x7FFF) + 0x8000); break; case 0x04: value = address16(io_registers, address & 0x3FF); break; case 0x05: value = address16(palette_ram, address & 0x3FF); break; case 0x06: address &= 0x1FFFF; if(address > 0x18000) address -= 0x8000; value = address16(vram, address); break; case 0x07: value = address16(oam_ram, address & 0x3FF); break; case 0x08: case 0x09: case 0x0A: case 0x0B: case 0x0C: if((address & 0x1FFFFFF) >= gamepak_size) { value = 0; } else { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address16(map, address & 0x7FFF); } break; case 0x0D: if((address & 0x1FFFFFF) < gamepak_size) { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address16(map, address & 0x7FFF); } else value = read_eeprom(); break; case 0x0E: case 0x0F: value = 0; break; default: if(!(reg[REG_CPSR] & 0x20)) value = read_memory16(reg[REG_PC] + 4 + (address & 0x02)); else value = read_memory16(reg[REG_PC] + 2); break; };
  }

  return value;
}


u32 function_cc read_memory32(u32 address)
{
  u32 value;
  if(address & 0x03)
  {
    u32 rotate = (address & 0x03) * 8;
    address &= ~0x03;
    switch(address >> 24) { case 0x00: if(reg[REG_PC] >= 0x4000) value = address32(&bios_read_protect, address & 0x03); else value = address32(bios_rom, address & 0x3FFF); break; case 0x02: address = (address & 0x7FFF) + ((address & 0x38000) * 2) + 0x8000; value = address32(ewram, address); break; case 0x03: value = address32(iwram, (address & 0x7FFF) + 0x8000); break; case 0x04: value = address32(io_registers, address & 0x3FF); break; case 0x05: value = address32(palette_ram, address & 0x3FF); break; case 0x06: address &= 0x1FFFF; if(address > 0x18000) address -= 0x8000; value = address32(vram, address); break; case 0x07: value = address32(oam_ram, address & 0x3FF); break; case 0x08: case 0x09: case 0x0A: case 0x0B: case 0x0C: if((address & 0x1FFFFFF) >= gamepak_size) { value = 0; } else { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address32(map, address & 0x7FFF); } break; case 0x0D: if((address & 0x1FFFFFF) < gamepak_size) { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address32(map, address & 0x7FFF); } else value = read_eeprom(); break; case 0x0E: case 0x0F: value = 0; break; default: if(!(reg[REG_CPSR] & 0x20)) { value = read_memory32(reg[REG_PC] + 4); } else { u32 current_instruction = read_memory16(reg[REG_PC] + 2); value = current_instruction | (current_instruction << 16); }; break; };
    ror(value, value, rotate);
  }
  else
  {
    switch(address >> 24) { case 0x00: if(reg[REG_PC] >= 0x4000) value = address32(&bios_read_protect, address & 0x03); else value = address32(bios_rom, address & 0x3FFF); break; case 0x02: address = (address & 0x7FFF) + ((address & 0x38000) * 2) + 0x8000; value = address32(ewram, address); break; case 0x03: value = address32(iwram, (address & 0x7FFF) + 0x8000); break; case 0x04: value = address32(io_registers, address & 0x3FF); break; case 0x05: value = address32(palette_ram, address & 0x3FF); break; case 0x06: address &= 0x1FFFF; if(address > 0x18000) address -= 0x8000; value = address32(vram, address); break; case 0x07: value = address32(oam_ram, address & 0x3FF); break; case 0x08: case 0x09: case 0x0A: case 0x0B: case 0x0C: if((address & 0x1FFFFFF) >= gamepak_size) { value = 0; } else { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address32(map, address & 0x7FFF); } break; case 0x0D: if((address & 0x1FFFFFF) < gamepak_size) { u32 gamepak_index = address >> 15; u8 *map = memory_map_read[gamepak_index]; if(!map) map = load_gamepak_page(gamepak_index & 0x3FF); value = address32(map, address & 0x7FFF); } else value = read_eeprom(); break; case 0x0E: case 0x0F: value = 0; break; default: if(!(reg[REG_CPSR] & 0x20)) { value = read_memory32(reg[REG_PC] + 4); } else { u32 current_instruction = read_memory16(reg[REG_PC] + 2); value = current_instruction | (current_instruction << 16); }; break; };
  }

  return value;
}

cpu_alert_type function_cc write_memory8(u32 address, u8 value)
{
  switch(address >> 24) { case 0x02: address = (address & 0x7FFF) + ((address & 0x38000) * 2) + 0x8000; address8(ewram, address) = value; break; case 0x03: address8(iwram, (address & 0x7FFF) + 0x8000) = value; break; case 0x04: return write_io_register8(address & 0x3FF, value); case 0x05: ; break; case 0x06: address &= 0x1FFFF; if(address >= 0x18000) address -= 0x8000; address &= ~0x01; address16(vram, address) = ((value << 8) | value); break; case 0x07: oam_update = 1; address8(oam_ram, address & 0x3FF) = value; break; case 0x08: ; break; case 0x09 ... 0x0C: break; case 0x0D: write_eeprom(address, value); break; case 0x0E: write_backup(address & 0xFFFF, value); break; };
  return CPU_ALERT_NONE;
}

cpu_alert_type function_cc write_memory16(u32 address, u16 value)
{
  switch(address >> 24) { case 0x02: address = (address & 0x7FFF) + ((address & 0x38000) * 2) + 0x8000; address16(ewram, address) = value; break; case 0x03: address16(iwram, (address & 0x7FFF) + 0x8000) = value; break; case 0x04: return write_io_register16(address & 0x3FF, value); case 0x05: { u32 palette_address = address & 0x3FF; address16(palette_ram, palette_address) = value; convert_palette(value); address16(palette_ram_converted, palette_address) = value; }; break; case 0x06: address &= 0x1FFFF; if(address >= 0x18000) address -= 0x8000; address16(vram, address) = value; break; case 0x07: oam_update = 1; address16(oam_ram, address & 0x3FF) = value; break; case 0x08: write_rtc(address & 0xFF, value); break; case 0x09 ... 0x0C: break; case 0x0D: write_eeprom(address, value); break; case 0x0E: ; break; };
  return CPU_ALERT_NONE;
}

cpu_alert_type function_cc write_memory32(u32 address, u32 value)
{
  switch(address >> 24) { case 0x02: address = (address & 0x7FFF) + ((address & 0x38000) * 2) + 0x8000; address32(ewram, address) = value; break; case 0x03: address32(iwram, (address & 0x7FFF) + 0x8000) = value; break; case 0x04: return write_io_register32(address & 0x3FF, value); case 0x05: { u32 palette_address = address & 0x3FF; u32 value_high = value >> 16; u32 value_low = value & 0xFFFF; address32(palette_ram, palette_address) = value; convert_palette(value_high); convert_palette(value_low); value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = value; }; break; case 0x06: address &= 0x1FFFF; if(address >= 0x18000) address -= 0x8000; address32(vram, address) = value; break; case 0x07: oam_update = 1; address32(oam_ram, address & 0x3FF) = value; break; case 0x08: ; break; case 0x09 ... 0x0C: break; case 0x0D: write_eeprom(address, value); break; case 0x0E: ; break; };
  return CPU_ALERT_NONE;
}

char backup_filename[512];

u32 load_backup(char *name)
{
  file_open(backup_file, name, read);

  if(file_check_valid(backup_file))
  {
    u32 backup_size = file_length(name, backup_file);

    file_read(backup_file, gamepak_backup, backup_size);

    file_close(backup_file);


    switch(backup_size)
    {
      case 0x200:
        backup_type = BACKUP_EEPROM;
        eeprom_size = EEPROM_512_BYTE;
        break;

      case 0x2000:
        backup_type = BACKUP_EEPROM;
        eeprom_size = EEPROM_8_KBYTE;
        break;

      case 0x8000:
        backup_type = BACKUP_SRAM;
        sram_size = SRAM_SIZE_32KB;
        break;


      case 0x10000:
        backup_type = BACKUP_FLASH;
        sram_size = (sram_size_type)FLASH_SIZE_64KB;
        break;

      case 0x20000:
        backup_type = BACKUP_FLASH;
        flash_size = FLASH_SIZE_128KB;
        break;
    }
    return 1;
  }
  else
  {
    backup_type = BACKUP_NONE;
    memset(gamepak_backup, 0xFF, 1024 * 128);
  }

  return 0;
}

u32 save_backup(char *name)
{
  if(backup_type != BACKUP_NONE)
  {
    file_open(backup_file, name, write);

    if(file_check_valid(backup_file))
    {
      u32 backup_size = 0;

      switch(backup_type)
      {
        case BACKUP_SRAM:
          if(sram_size == SRAM_SIZE_32KB)
            backup_size = 0x8000;
          else
            backup_size = 0x10000;
          break;

        case BACKUP_FLASH:
          if(flash_size == FLASH_SIZE_64KB)
            backup_size = 0x10000;
          else
            backup_size = 0x20000;
          break;

        case BACKUP_EEPROM:
          if(eeprom_size == EEPROM_512_BYTE)
            backup_size = 0x200;
          else
            backup_size = 0x2000;
          break;

        default:
          break;
      }

      file_write(backup_file, gamepak_backup, backup_size);

      file_close(backup_file);
      return 1;
    }
  }

  return 0;
}

void update_backup(void)
{
  save_backup(backup_filename);
}



char *skip_spaces(char *line_ptr)
{
  while(*line_ptr == ' ')
    line_ptr++;

  return line_ptr;
}

s32 parse_config_line(char *current_line, char *current_variable, char *current_value)
{
  char *line_ptr = current_line;
  char *line_ptr_new;

  if((current_line[0] == 0) || (current_line[0] == '#'))
    return -1;

  line_ptr_new = strchr(line_ptr, ' ');
  if(!line_ptr_new)
    return -1;

  *line_ptr_new = 0;
  strcpy(current_variable, line_ptr);
  line_ptr_new = skip_spaces(line_ptr_new + 1);

  if(*line_ptr_new != '=')
    return -1;

  line_ptr_new = skip_spaces(line_ptr_new + 1);
  strcpy(current_value, line_ptr_new);
  line_ptr_new = current_value + strlen(current_value) - 1;
  if(*line_ptr_new == '\n')
  {
    line_ptr_new--;
    *line_ptr_new = 0;
  }

  if(*line_ptr_new == '\r')
    *line_ptr_new = 0;

  return 0;
}

s32 load_game_config(char *gamepak_title, char *gamepak_code, char *gamepak_maker)
{
  char current_line[256];
  char current_variable[256];
  char current_value[256];
  char config_path[512];
  FILE *config_file;

  idle_loop_target_pc = 0xFFFFFFFF;
  iwram_stack_optimize = 1;
  translation_gate_targets = 0;
  bios_rom[0x39] = 0x00;
  bios_rom[0x2C] = 0x00;
  flash_device_id = FLASH_DEVICE_MACRONIX_64KB;

  sprintf(config_path, "%s" PATH_SEPARATOR "%s", main_path, "game_config.txt");

  printf("config_path is : %s\n", config_path);

  config_file = fopen(config_path, "rb");

  if(config_file)
  {
    while(fgets(current_line, 256, config_file))
    {
      if(parse_config_line(current_line, current_variable, current_value)
       != -1)
      {
        if(strcmp(current_variable, "game_name") ||
         strcmp(current_value, gamepak_title))
          continue;

        if(!fgets(current_line, 256, config_file) ||
         (parse_config_line(current_line, current_variable,
           current_value) == -1) ||
         strcmp(current_variable, "game_code") ||
         strcmp(current_value, gamepak_code))
          continue;

        if(!fgets(current_line, 256, config_file) ||
         (parse_config_line(current_line, current_variable,
           current_value) == -1) ||
         strcmp(current_variable, "vender_code") ||
          strcmp(current_value, gamepak_maker))
          continue;

        while(fgets(current_line, 256, config_file))
        {
          if(parse_config_line(current_line, current_variable, current_value)
           != -1)
          {
            if(!strcmp(current_variable, "game_name"))
            {
              fclose(config_file);
              return 0;
            }

            if(!strcmp(current_variable, "idle_loop_eliminate_target"))
               idle_loop_target_pc = strtol(current_value, NULL, 16);

            if(!strcmp(current_variable, "translation_gate_target"))
            {
               if(translation_gate_targets < MAX_TRANSLATION_GATES)
               {
                  translation_gate_target_pc[translation_gate_targets] =
                     strtol(current_value, NULL, 16);
                  translation_gate_targets++;
               }
            }

            if(!strcmp(current_variable, "iwram_stack_optimize") &&
                  !strcmp(current_value, "no\0"))
               iwram_stack_optimize = 0;

            if(!strcmp(current_variable, "flash_rom_type") &&
              !strcmp(current_value, "128KB"))
              flash_device_id = FLASH_DEVICE_MACRONIX_128KB;

            if(!strcmp(current_variable, "bios_rom_hack_39") &&
              !strcmp(current_value, "yes"))
              bios_rom[0x39] = 0xC0;

            if(!strcmp(current_variable, "bios_rom_hack_2C") &&
              !strcmp(current_value, "yes"))
               bios_rom[0x2C] = 0x02;
          }
        }

        fclose(config_file);
        return 0;
      }
    }

    fclose(config_file);
  }


  printf("game config missing\n");

  return -1;
}

s32 load_gamepak_raw(const char *name)
{
  file_open(gamepak_file, name, read);

  if(file_check_valid(gamepak_file))
  {
    u32 file_size = file_length(name, gamepak_file);



    if(file_check_valid(gamepak_file_large))
      file_close(gamepak_file_large);



    if(file_size <= gamepak_ram_buffer_size)
    {
      file_read(gamepak_file, gamepak_rom, file_size);

      file_close(gamepak_file);




      gamepak_file_large = NULL;

    }
    else
    {

      file_read(gamepak_file, gamepak_rom, 0x100);
      gamepak_file_large = gamepak_file;
    }

    return file_size;
  }

  return -1;
}

char gamepak_title[13];
char gamepak_code[5];
char gamepak_maker[3];
char gamepak_filename[512];

u32 load_gamepak(const char *name)
{
  char cheats_filename[256];
  char *p;

  s32 file_size = load_gamepak_raw(name);



  if(file_size != -1)
  {
    gamepak_size = (file_size + 0x7FFF) & ~0x7FFF;

    strncpy(gamepak_filename, name, sizeof(gamepak_filename));
    gamepak_filename[sizeof(gamepak_filename) - 1] = 0;

    p = strrchr(gamepak_filename, PATH_SEPARATOR_CHAR);
    if (!p)
      p = gamepak_filename;

    snprintf(backup_filename, sizeof(backup_filename), "%s/%s", save_path, p);
    p = strrchr(backup_filename, '.');
    if (p)
      strcpy(p, ".sav");

    load_backup(backup_filename);

    memcpy(gamepak_title, gamepak_rom + 0xA0, 12);
    memcpy(gamepak_code, gamepak_rom + 0xAC, 4);
    memcpy(gamepak_maker, gamepak_rom + 0xB0, 2);
    gamepak_title[12] = 0;
    gamepak_code[4] = 0;
    gamepak_maker[2] = 0;

    load_game_config(gamepak_title, gamepak_code, gamepak_maker);

    change_ext(gamepak_filename, cheats_filename, ".cht");
    add_cheats(cheats_filename);

    return 0;
  }

  return -1;
}

s32 load_bios(char *name)
{
  file_open(bios_file, name, read);

  if(file_check_valid(bios_file))
  {
    file_read(bios_file, bios_rom, 0x4000);



    file_close(bios_file);
    return 0;
  }

  return -1;
}

typedef enum
{
  DMA_REGION_IWRAM,
  DMA_REGION_EWRAM,
  DMA_REGION_VRAM,
  DMA_REGION_PALETTE_RAM,
  DMA_REGION_OAM_RAM,
  DMA_REGION_IO,
  DMA_REGION_GAMEPAK,
  DMA_REGION_EXT,
  DMA_REGION_BIOS,
  DMA_REGION_NULL
} dma_region_type;

dma_region_type dma_region_map[16] =
{
  DMA_REGION_BIOS,
  DMA_REGION_NULL,
  DMA_REGION_EWRAM,
  DMA_REGION_IWRAM,
  DMA_REGION_IO,
  DMA_REGION_PALETTE_RAM,
  DMA_REGION_VRAM,
  DMA_REGION_OAM_RAM,
  DMA_REGION_GAMEPAK,
  DMA_REGION_GAMEPAK,
  DMA_REGION_GAMEPAK,
  DMA_REGION_GAMEPAK,
  DMA_REGION_GAMEPAK,
  DMA_REGION_EXT,
  DMA_REGION_EXT,
  DMA_REGION_EXT
};

cpu_alert_type dma_transfer(dma_transfer_type *dma)
{
  u32 i;
  u32 length = dma->length;
  u32 read_value;
  u32 src_ptr = dma->source_address;
  u32 dest_ptr = dma->dest_address;
  cpu_alert_type return_value = CPU_ALERT_NONE;




  if((dest_ptr >> 24) != ((dest_ptr + length - 1) >> 24))
  {
    u32 first_length = ((dest_ptr & 0xFF000000) + 0x1000000) - dest_ptr;
    u32 second_length = length - first_length;
    dma->length = first_length;

    dma_transfer(dma);

    dma->length = length;

    length = second_length;
    dest_ptr += first_length;
    src_ptr += first_length;
  }

  if(dma->length_type == DMA_16BIT)
  {
    src_ptr &= ~0x01;
    dest_ptr &= ~0x01;
    cycle_dma16_words += length;

    switch((dma->dest_direction << 2) | dma->source_direction)
    {
       case 0x00:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x01:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x02:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x03:
          break;
       case 0x04:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x05:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x06:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); ; dest_ptr -= (16 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x07:
          break;
       case 0x08:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x09:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x0A:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x0B:
          break;
       case 0x0C:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); src_ptr += (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; } break; };
       case 0x0D:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); src_ptr -= (16 / 8); dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; } break; };
       case 0x0E:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address16(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address16(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; address16(palette_ram, palette_address) = read_value; convert_palette(read_value); address16(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); address16(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_io_register16(dest_ptr & 0x3FF, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(iwram + 0x8000, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(vram, src_ptr & 0x1FFFF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(palette_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(oam_ram, src_ptr & 0x3FF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address16(io_registers, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address16(src_address_block, src_ptr & 0x7FFF); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory16(src_ptr); write_memory16(dest_ptr, read_value); ; dest_ptr += (16 / 8); } dma->source_address = src_ptr; ; ; break; }; } break; };
       case 0x0F:
          break;
    }
  }
  else
  {
    src_ptr &= ~0x03;
    dest_ptr &= ~0x03;
    cycle_dma32_words += length;

    switch((dma->dest_direction << 2) | dma->source_direction)
    {
       case 0x00:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x01:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x02:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x03:
          break;
       case 0x04:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x05:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x06:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); ; dest_ptr -= (32 / 8); } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x07:
          break;
       case 0x08:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x09:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x0A:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); ; ; } dma->source_address = src_ptr; dma->dest_address = dest_ptr; ; break; }; } break; };
       case 0x0B:
          break;
       case 0x0C:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); src_ptr += (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; } break; };
       case 0x0D:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); src_ptr -= (32 / 8); dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; } break; };
       case 0x0E:
          ; { u32 src_region = src_ptr >> 24; u32 dest_region = dest_ptr >> 24; dma_region_type src_region_type = dma_region_map[src_region]; dma_region_type dest_region_type = dma_region_map[dest_region]; switch(src_region_type | (dest_region_type << 4)) { case (DMA_REGION_BIOS | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = 0; address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_IWRAM << 4)): { ; u32 smc_trigger = 0; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(iwram + 0x8000, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(iwram, dest_ptr & 0x7FFF); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = 0; dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EWRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_IO | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EWRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_EXT | (DMA_REGION_EWRAM << 4)): { ; u32 smc_trigger = 0; u32 dest_new_region; u32 dest_current_region = dest_ptr >> 15; u8 *dest_address_block = memory_map_write[dest_current_region]; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); dest_new_region = (dest_ptr >> 15); if(dest_new_region != dest_current_region) { dest_current_region = dest_new_region; dest_address_block = memory_map_write[dest_current_region]; }; address32(dest_address_block, dest_ptr & 0x7FFF) = read_value; smc_trigger |= address32(dest_address_block, (dest_ptr & 0x7FFF) - 0x8000); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; if(smc_trigger) { return_value = CPU_ALERT_SMC; }; break; }; case (DMA_REGION_BIOS | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_VRAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_VRAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_VRAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(vram, dest_ptr & 0x1FFFF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_PALETTE_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_PALETTE_RAM << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); { u32 palette_address = dest_ptr & 0x3FF; u32 value_high = read_value >> 16; u32 value_low = read_value & 0xFFFF; address32(palette_ram, palette_address) = read_value; convert_palette(value_high); convert_palette(value_low); read_value = (value_high << 16) | value_low; address32(palette_ram_converted, palette_address) = read_value; }; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = 0; address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_OAM_RAM << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_OAM_RAM << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; oam_update = 1; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_OAM_RAM << 4)): { ; oam_update = 1; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); address32(oam_ram, dest_ptr & 0x3FF) = read_value; ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_IO << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_IO << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_IO << 4)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_io_register32(dest_ptr & 0x3FF, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_BIOS | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = 0; write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IWRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(iwram + 0x8000, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EWRAM | (DMA_REGION_EXT << 4)): { ; u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_VRAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(vram, src_ptr & 0x1FFFF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_PALETTE_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(palette_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_OAM_RAM | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(oam_ram, src_ptr & 0x3FF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_IO | (DMA_REGION_EXT << 4)): { ; ; for(i = 0; i < length; i++) { read_value = address32(io_registers, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_GAMEPAK | (DMA_REGION_EXT << 4)): { u32 src_new_region; u32 src_current_region = src_ptr >> 15; u8 *src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { if((src_ptr & 0x1FFFFFF) >= gamepak_size) break; src_address_block = load_gamepak_page(src_current_region & 0x3FF); }; ; for(i = 0; i < length; i++) { src_new_region = (src_ptr >> 15); if(src_new_region != src_current_region) { src_current_region = src_new_region; src_address_block = memory_map_read[src_current_region]; if(src_address_block == NULL) { src_address_block = load_gamepak_page(src_current_region & 0x3FF); } }; read_value = address32(src_address_block, src_ptr & 0x7FFF); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; case (DMA_REGION_EXT | (DMA_REGION_EXT << 3)): { ; ; for(i = 0; i < length; i++) { read_value = read_memory32(src_ptr); write_memory32(dest_ptr, read_value); ; dest_ptr += (32 / 8); } dma->source_address = src_ptr; ; ; break; }; } break; };
       case 0x0F:
          break;
    }
  }

  if((dma->repeat_type == DMA_NO_REPEAT) ||
   (dma->start_type == DMA_START_IMMEDIATELY))
  {
    dma->start_type = DMA_INACTIVE;
    address16(io_registers, (dma->dma_channel * 12) + 0xBA) &=
     (~0x8000);
  }

  if(dma->irq)
  {
    raise_interrupt(IRQ_DMA0 << dma->dma_channel);
    return_value = CPU_ALERT_IRQ;
  }

  return return_value;
}

u32 page_time = 0;

u32 evict_gamepak_page(void)
{

  u32 page_index = 0;
  u32 physical_index;
  u32 smallest = gamepak_memory_map[0].page_timestamp;
  u32 i;

  for(i = 1; i < gamepak_ram_pages; i++)
  {
    if(gamepak_memory_map[i].page_timestamp <= smallest)
    {
      smallest = gamepak_memory_map[i].page_timestamp;
      page_index = i;
    }
  }

  physical_index = gamepak_memory_map[page_index].physical_index;

  memory_map_read[(0x8000000 / (32 * 1024)) + physical_index] = NULL;
  memory_map_read[(0xA000000 / (32 * 1024)) + physical_index] = NULL;
  memory_map_read[(0xC000000 / (32 * 1024)) + physical_index] = NULL;

  return page_index;
}

u8 *load_gamepak_page(u32 physical_index)
{
  if(physical_index >= (gamepak_size >> 15))
    return gamepak_rom;

  u32 page_index = evict_gamepak_page();
  u32 page_offset = page_index * (32 * 1024);
  u8 *swap_location = gamepak_rom + page_offset;

  gamepak_memory_map[page_index].page_timestamp = page_time;
  gamepak_memory_map[page_index].physical_index = physical_index;
  page_time++;

  file_seek(gamepak_file_large, physical_index * (32 * 1024), SEEK_SET);
  file_read(gamepak_file_large, swap_location, (32 * 1024));
  memory_map_read[(0x8000000 / (32 * 1024)) + physical_index] = swap_location;
  memory_map_read[(0xA000000 / (32 * 1024)) + physical_index] = swap_location;
  memory_map_read[(0xC000000 / (32 * 1024)) + physical_index] = swap_location;


  if((rtc_state != RTC_DISABLED) && (physical_index == 0))
    memcpy(swap_location + 0xC4, rtc_registers, sizeof(rtc_registers));

  return swap_location;
}

void init_memory_gamepak(void)
{
  u32 map_offset = 0;

  if(gamepak_size > gamepak_ram_buffer_size)
  {


    u32 i;
    for(i = 0; i < gamepak_ram_pages; i++)
    {
      gamepak_memory_map[i].page_timestamp = 0;
      gamepak_memory_map[i].physical_index = 0;
    }

    for(map_offset = 0x8000000 / 0x8000; map_offset < (0xD000000 / 0x8000); map_offset++) memory_map_read[map_offset] = NULL;;
  }
  else
  {
    for(map_offset = (0x8000000) / 0x8000; map_offset < ((0x8000000 + gamepak_size) / 0x8000); map_offset++) { memory_map_read[map_offset] = ((u8 *)gamepak_rom) + ((map_offset % 1024) * 0x8000); };
    for(map_offset = 0x8000000 + gamepak_size / 0x8000; map_offset < (0xA000000 / 0x8000); map_offset++) memory_map_read[map_offset] = NULL;;
    for(map_offset = (0xA000000) / 0x8000; map_offset < ((0xA000000 + gamepak_size) / 0x8000); map_offset++) { memory_map_read[map_offset] = ((u8 *)gamepak_rom) + ((map_offset % 1024) * 0x8000); };
    for(map_offset = 0xA000000 + gamepak_size / 0x8000; map_offset < (0xC000000 / 0x8000); map_offset++) memory_map_read[map_offset] = NULL;;
    for(map_offset = (0xC000000) / 0x8000; map_offset < ((0xC000000 + gamepak_size) / 0x8000); map_offset++) { memory_map_read[map_offset] = ((u8 *)gamepak_rom) + ((map_offset % 1024) * 0x8000); };
    for(map_offset = 0xC000000 + gamepak_size / 0x8000; map_offset < (0xE000000 / 0x8000); map_offset++) memory_map_read[map_offset] = NULL;;
  }
}

void init_gamepak_buffer(void)
{

  gamepak_rom = NULL;

  gamepak_ram_buffer_size = 32 * 1024 * 1024;
  gamepak_rom = malloc(gamepak_ram_buffer_size);

  if(!gamepak_rom)
  {

    gamepak_ram_buffer_size = 16 * 1024 * 1024;
    gamepak_rom = malloc(gamepak_ram_buffer_size);

    while(!gamepak_rom)
    {
      gamepak_ram_buffer_size -= (2 * 1024 * 1024);
      gamepak_rom = malloc(gamepak_ram_buffer_size);
    }
  }



  gamepak_ram_pages = gamepak_ram_buffer_size / (32 * 1024);
  gamepak_memory_map = malloc(sizeof(gamepak_swap_entry_type) *
   gamepak_ram_pages);
}

void init_memory(void)
{
  u32 map_offset = 0;

  memory_regions[0x00] = (u8 *)bios_rom;
  memory_regions[0x01] = (u8 *)bios_rom;
  memory_regions[0x02] = (u8 *)ewram;
  memory_regions[0x03] = (u8 *)iwram + 0x8000;
  memory_regions[0x04] = (u8 *)io_registers;
  memory_regions[0x05] = (u8 *)palette_ram;
  memory_regions[0x06] = (u8 *)vram;
  memory_regions[0x07] = (u8 *)oam_ram;
  memory_regions[0x08] = (u8 *)gamepak_rom;
  memory_regions[0x09] = (u8 *)(gamepak_rom + 0xFFFFFF);
  memory_regions[0x0A] = (u8 *)gamepak_rom;
  memory_regions[0x0B] = (u8 *)(gamepak_rom + 0xFFFFFF);
  memory_regions[0x0C] = (u8 *)gamepak_rom;
  memory_regions[0x0D] = (u8 *)(gamepak_rom + 0xFFFFFF);
  memory_regions[0x0E] = (u8 *)gamepak_backup;

  memory_limits[0x00] = 0x3FFF;
  memory_limits[0x01] = 0x3FFF;
  memory_limits[0x02] = 0x3FFFF;
  memory_limits[0x03] = 0x7FFF;
  memory_limits[0x04] = 0x7FFF;
  memory_limits[0x05] = 0x3FF;
  memory_limits[0x06] = 0x17FFF;
  memory_limits[0x07] = 0x3FF;
  memory_limits[0x08] = 0x1FFFFFF;
  memory_limits[0x09] = 0x1FFFFFF;
  memory_limits[0x0A] = 0x1FFFFFF;
  memory_limits[0x0B] = 0x1FFFFFF;
  memory_limits[0x0C] = 0x1FFFFFF;
  memory_limits[0x0D] = 0x1FFFFFF;
  memory_limits[0x0E] = 0xFFFF;


  for(map_offset = (0x0000000) / 0x8000; map_offset < ((0x1000000) / 0x8000); map_offset++) { memory_map_read[map_offset] = ((u8 *)bios_rom) + ((map_offset % 1) * 0x8000); };
  for(map_offset = 0x1000000 / 0x8000; map_offset < (0x2000000 / 0x8000); map_offset++) memory_map_read[map_offset] = NULL;;
  for(map_offset = (0x2000000) / 0x8000; map_offset < ((0x3000000) / 0x8000); map_offset++) { memory_map_read[map_offset] = ((u8 *)ewram) + ((map_offset % 8) * 0x10000) + 0x8000; };
  for(map_offset = (0x3000000) / 0x8000; map_offset < ((0x4000000) / 0x8000); map_offset++) { memory_map_read[map_offset] = ((u8 *)iwram) + ((map_offset % 1) * 0x10000) + 0x8000; };
  for(map_offset = (0x4000000) / 0x8000; map_offset < ((0x5000000) / 0x8000); map_offset++) { memory_map_read[map_offset] = ((u8 *)io_registers) + ((map_offset % 1) * 0x8000); };
  for(map_offset = 0x5000000 / 0x8000; map_offset < (0x6000000 / 0x8000); map_offset++) memory_map_read[map_offset] = NULL;;
  for(map_offset = 0x6000000 / 0x8000; map_offset < (0x7000000 / 0x8000); map_offset++) memory_map_read[map_offset] = NULL;;
  for(map_offset = 0x6000000 / 0x8000; map_offset < (0x7000000 / 0x8000); map_offset += 4) { memory_map_read[map_offset] = vram; memory_map_read[map_offset + 1] = vram + 0x8000; memory_map_read[map_offset + 2] = vram + (0x8000 * 2); memory_map_read[map_offset + 3] = vram + (0x8000 * 2); };
  for(map_offset = 0x7000000 / 0x8000; map_offset < (0x8000000 / 0x8000); map_offset++) memory_map_read[map_offset] = NULL;;
  init_memory_gamepak();
  for(map_offset = 0xE000000 / 0x8000; map_offset < (0x10000000 / 0x8000); map_offset++) memory_map_read[map_offset] = NULL;;


  for(map_offset = 0x0000000 / 0x8000; map_offset < (0x2000000 / 0x8000); map_offset++) memory_map_write[map_offset] = NULL;;
  for(map_offset = (0x2000000) / 0x8000; map_offset < ((0x3000000) / 0x8000); map_offset++) { memory_map_write[map_offset] = ((u8 *)ewram) + ((map_offset % 8) * 0x10000) + 0x8000; };
  for(map_offset = (0x3000000) / 0x8000; map_offset < ((0x4000000) / 0x8000); map_offset++) { memory_map_write[map_offset] = ((u8 *)iwram) + ((map_offset % 1) * 0x10000) + 0x8000; };
  for(map_offset = 0x4000000 / 0x8000; map_offset < (0x5000000 / 0x8000); map_offset++) memory_map_write[map_offset] = NULL;;
  for(map_offset = 0x5000000 / 0x8000; map_offset < (0x6000000 / 0x8000); map_offset++) memory_map_write[map_offset] = NULL;;

  if(direct_map_vram)
  {
    for(map_offset = 0x6000000 / 0x8000; map_offset < (0x7000000 / 0x8000); map_offset += 4) { memory_map_write[map_offset] = vram; memory_map_write[map_offset + 1] = vram + 0x8000; memory_map_write[map_offset + 2] = vram + (0x8000 * 2); memory_map_write[map_offset + 3] = vram + (0x8000 * 2); };
  }
  else
  {
    for(map_offset = 0x6000000 / 0x8000; map_offset < (0x7000000 / 0x8000); map_offset++) memory_map_write[map_offset] = NULL;;
  }

  for(map_offset = 0x7000000 / 0x8000; map_offset < (0x8000000 / 0x8000); map_offset++) memory_map_write[map_offset] = NULL;;
  for(map_offset = 0x8000000 / 0x8000; map_offset < (0xE000000 / 0x8000); map_offset++) memory_map_write[map_offset] = NULL;;
  for(map_offset = 0xE000000 / 0x8000; map_offset < (0x10000000 / 0x8000); map_offset++) memory_map_write[map_offset] = NULL;;

  memset(io_registers, 0, 0x8000);
  memset(oam_ram, 0, 0x400);
  memset(palette_ram, 0, 0x400);
  memset(iwram, 0, 0x10000);
  memset(ewram, 0, 0x80000);
  memset(vram, 0, 0x18000);

  io_registers[REG_DISPCNT] = 0x80;
  io_registers[REG_P1] = 0x3FF;
  io_registers[REG_BG2PA] = 0x100;
  io_registers[REG_BG2PD] = 0x100;
  io_registers[REG_BG3PA] = 0x100;
  io_registers[REG_BG3PD] = 0x100;
  io_registers[REG_RCNT] = 0x8000;

  backup_type = BACKUP_NONE;

  sram_size = SRAM_SIZE_32KB;
  flash_size = FLASH_SIZE_64KB;

  flash_bank_ptr = gamepak_backup;
  flash_command_position = 0;
  eeprom_size = EEPROM_512_BYTE;
  eeprom_mode = EEPROM_BASE_MODE;
  eeprom_address = 0;
  eeprom_counter = 0;

  flash_mode = FLASH_BASE_MODE;

  rtc_state = RTC_DISABLED;
  memset(rtc_registers, 0, sizeof(rtc_registers));
  bios_read_protect = 0xe129f000;
}

void memory_term(void)
{
  if (file_check_valid(gamepak_file_large))
  {
    file_close(gamepak_file_large);
  }

  if (gamepak_memory_map)
  {
    free(gamepak_memory_map);
    gamepak_memory_map = NULL;
  }

  if (gamepak_rom)
  {
    free(gamepak_rom);
    gamepak_rom = NULL;
  }
}

void bios_region_read_allow(void)
{
  memory_map_read[0] = bios_rom;
}

void bios_region_read_protect(void)
{
  memory_map_read[0] = NULL;
}

const u8 *state_mem_read_ptr;
u8 *state_mem_write_ptr;

void gba_load_state(const void* src)
{
   u32 i;
   u32 current_color;

   state_mem_read_ptr = src;
   cpu_read_savestate(); input_read_savestate(); main_read_savestate(); memory_read_savestate(); sound_read_savestate(); video_read_savestate();

   oam_update = 1;
   gbc_sound_update = 1;

   for(i = 0; i < 512; i++)
   {
      current_color = palette_ram[i];
      palette_ram_converted[i] =
       convert_palette(current_color);
   }


   for(i = 0; i < 4; i++)
      gbc_sound_channel[i].sample_data = square_pattern_duty[2];

   instruction_count = 0;

   reg[CHANGED_PC_STATUS] = 1;
}

void gba_save_state(void* dst)
{
  state_mem_write_ptr = dst;
  cpu_write_savestate(); input_write_savestate(); main_write_savestate(); memory_write_savestate(); sound_write_savestate(); video_write_savestate();
}

void memory_read_savestate(void) { u32 i; state_mem_read_variable(backup_type); state_mem_read_variable(sram_size); state_mem_read_variable(flash_mode); state_mem_read_variable(flash_command_position); state_mem_read_variable(flash_bank_ptr); state_mem_read_variable(flash_device_id); state_mem_read_variable(flash_manufacturer_id); state_mem_read_variable(flash_size); state_mem_read_variable(eeprom_size); state_mem_read_variable(eeprom_mode); state_mem_read_variable(eeprom_address_length); state_mem_read_variable(eeprom_address); state_mem_read_variable(eeprom_counter); state_mem_read_variable(rtc_state); state_mem_read_variable(rtc_write_mode); state_mem_read_array(rtc_registers); state_mem_read_variable(rtc_command); state_mem_read_array(rtc_data); state_mem_read_variable(rtc_status); state_mem_read_variable(rtc_data_bytes); state_mem_read_variable(rtc_bit_count); state_mem_read_array(eeprom_buffer); state_mem_read_array(dma); state_mem_read(iwram + 0x8000, 0x8000); for(i = 0; i < 8; i++) { state_mem_read(ewram + (i * 0x10000) + 0x8000, 0x8000); } state_mem_read(vram, 0x18000); state_mem_read(oam_ram, 0x400); state_mem_read(palette_ram, 0x400); state_mem_read(io_registers, 0x8000); if((flash_bank_ptr < gamepak_backup) || (flash_bank_ptr > (gamepak_backup + (1024 * 64)))) flash_bank_ptr = gamepak_backup; }
void memory_write_savestate(void) { u32 i; state_mem_write_variable(backup_type); state_mem_write_variable(sram_size); state_mem_write_variable(flash_mode); state_mem_write_variable(flash_command_position); state_mem_write_variable(flash_bank_ptr); state_mem_write_variable(flash_device_id); state_mem_write_variable(flash_manufacturer_id); state_mem_write_variable(flash_size); state_mem_write_variable(eeprom_size); state_mem_write_variable(eeprom_mode); state_mem_write_variable(eeprom_address_length); state_mem_write_variable(eeprom_address); state_mem_write_variable(eeprom_counter); state_mem_write_variable(rtc_state); state_mem_write_variable(rtc_write_mode); state_mem_write_array(rtc_registers); state_mem_write_variable(rtc_command); state_mem_write_array(rtc_data); state_mem_write_variable(rtc_status); state_mem_write_variable(rtc_data_bytes); state_mem_write_variable(rtc_bit_count); state_mem_write_array(eeprom_buffer); state_mem_write_array(dma); state_mem_write(iwram + 0x8000, 0x8000); for(i = 0; i < 8; i++) { state_mem_write(ewram + (i * 0x10000) + 0x8000, 0x8000); } state_mem_write(vram, 0x18000); state_mem_write(oam_ram, 0x400); state_mem_write(palette_ram, 0x400); state_mem_write(io_registers, 0x8000); if((flash_bank_ptr < gamepak_backup) || (flash_bank_ptr > (gamepak_backup + (1024 * 64)))) flash_bank_ptr = gamepak_backup; }
